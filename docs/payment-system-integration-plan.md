# é˜¿æ‹‰ä¼¯ä¹¦æ³•ç”Ÿæˆå™¨ - æ”¯ä»˜ç³»ç»Ÿé›†æˆæŠ€æœ¯æ–¹æ¡ˆ

> **é¡¹ç›®ç›®æ ‡**: å°†MkSaaSæ¨¡æ¿çš„è®¤è¯å’Œæ”¯ä»˜åŠŸèƒ½é›†æˆåˆ°ç°æœ‰é¡¹ç›®,å®ç°VIPè®¢é˜…ä»˜è´¹æ¨¡å¼  
> **åˆ›å»ºæ—¥æœŸ**: 2025-01-02  
> **çŠ¶æ€**: å¾…å®æ–½

---

## ğŸ“‹ ç›®å½•

1. [ä¸šåŠ¡éœ€æ±‚](#ä¸šåŠ¡éœ€æ±‚)
2. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
3. [æ–‡ä»¶è¿ç§»æ¸…å•](#æ–‡ä»¶è¿ç§»æ¸…å•)
4. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
5. [æ ¸å¿ƒåŠŸèƒ½å®ç°](#æ ¸å¿ƒåŠŸèƒ½å®ç°)
6. [å®æ–½æ­¥éª¤](#å®æ–½æ­¥éª¤)
7. [æµ‹è¯•è®¡åˆ’](#æµ‹è¯•è®¡åˆ’)
8. [ä¸Šçº¿æ£€æŸ¥](#ä¸Šçº¿æ£€æŸ¥)

---

## ä¸šåŠ¡éœ€æ±‚

### ç”¨æˆ·åˆ†å±‚

#### Freeç”¨æˆ·
- âœ… æ— é™PNGä¸‹è½½ (æœ‰æ°´å°)
- âœ… åŸºç¡€å­—ä½“ (5-8ä¸ª)
- âœ… åŸºç¡€æ ·å¼é€‰é¡¹
- âš ï¸ ä½åˆ†è¾¨ç‡ (72 DPI)

#### Proç”¨æˆ· ($29.99/å¹´)
- âœ… æ— é™PNG/SVGä¸‹è½½
- âœ… æ‰€æœ‰å­—ä½“ (17+ä¸ª)
- âœ… é«˜çº§æ ·å¼é€‰é¡¹
- âœ… é«˜åˆ†è¾¨ç‡ (300 DPI)
- âœ… æ— æ°´å°
- âœ… å•†ç”¨æˆæƒ

#### Ultraç”¨æˆ· (é¢„ç•™,æœªæ¥å®ç°)
- âœ… Proæ‰€æœ‰åŠŸèƒ½
- âœ… APIè®¿é—®
- âœ… æ‰¹é‡å¤„ç†
- âœ… ä¸“å±å­—ä½“
- âœ… ä¼˜å…ˆæ”¯æŒ

### æ ¸å¿ƒåŠŸèƒ½

1. **ç”¨æˆ·è®¤è¯**
   - Email + Passwordç™»å½•/æ³¨å†Œ
   - OAuth (Google, GitHub) - å¯é€‰
   - Sessionç®¡ç†
   - å¯†ç é‡ç½®

2. **è®¢é˜…ç®¡ç†**
   - Stripe Checkouté›†æˆ
   - è®¢é˜…åˆ›å»º/å–æ¶ˆ/ç»­è´¹
   - Webhookå¤„ç†
   - è®¢å•å†å²æŸ¥è¯¢

3. **æƒé™æ§åˆ¶**
   - SVGä¸‹è½½æƒé™æ£€æŸ¥
   - å­—ä½“è®¿é—®æ§åˆ¶
   - åˆ†è¾¨ç‡é™åˆ¶
   - æ°´å°æ·»åŠ /ç§»é™¤

4. **ç”¨æˆ·ä¸­å¿ƒ**
   - è®¢é˜…çŠ¶æ€æ˜¾ç¤º
   - å‘ç¥¨ä¸‹è½½
   - è´¦å·è®¾ç½®
   - å–æ¶ˆ/ç»­è®¢ç®¡ç†

5. **ç§¯åˆ†ç³»ç»Ÿ** (é¢„ç•™)
   - ç§¯åˆ†ä½™é¢æŸ¥è¯¢
   - ç§¯åˆ†æ¶ˆè€—è®°å½•
   - ç§¯åˆ†è´­ä¹°(ä¸€æ¬¡æ€§)
   - ç§¯åˆ†è¿‡æœŸå¤„ç†

---

## æŠ€æœ¯æ¶æ„

### æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: Next.js 14 (App Router)
- **è®¤è¯**: better-auth
- **æ”¯ä»˜**: Stripe
- **æ•°æ®åº“**: PostgreSQL (Neon/Supabase)
- **ORM**: Drizzle ORM
- **éƒ¨ç½²**: Cloudflare Pages
- **æ ·å¼**: Tailwind CSS + shadcn/ui
- **å›½é™…åŒ–**: next-intl (å·²æœ‰)

### ç›®å½•ç»“æ„

âš ï¸ **é‡è¦**: é¡¹ç›®ä½¿ç”¨æ ¹ç›®å½•ç»“æ„,tsconfig.jsonä¸­ `@/*` æ˜ å°„åˆ° `./`  
æ‰€æœ‰å¯¼å…¥è·¯å¾„ä½¿ç”¨ `@/lib/...` è€Œé `@/src/lib/...`

```
arabic-calligraphy-creator/
â”œâ”€â”€ lib/                   # å·¥å…·å‡½æ•°å’Œé…ç½®
â”‚   â”œâ”€â”€ auth.ts            # âœ… ä» mksaas/src/lib/auth.ts å¤åˆ¶ - better-authæœåŠ¡ç«¯é…ç½®
â”‚   â”œâ”€â”€ auth-client.ts     # âœ… ä» mksaas/src/lib/auth-client.ts å¤åˆ¶ - å®¢æˆ·ç«¯hooks
â”‚   â”œâ”€â”€ price-plan.ts      # âœ… ä» mksaas/src/lib/price-plan.ts å¤åˆ¶ - ä»·æ ¼è®¡åˆ’å·¥å…·
â”‚   â”œâ”€â”€ subscription.ts    # âœ… æ–°å»º - è®¢é˜…çŠ¶æ€æ£€æŸ¥(server-only,å‚è€ƒmksaasç±»ä¼¼é€»è¾‘)
â”‚   â””â”€â”€ urls/              # âœ… ä» mksaas/src/lib/urls/ å¤åˆ¶æ•´ä¸ªç›®å½• - URLå·¥å…·
â”‚       â””â”€â”€ urls.ts
â”‚
â”œâ”€â”€ config/                # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ website.tsx        # âœ… ä» mksaas/src/config/website.tsx å¤åˆ¶ - å…¨å±€é…ç½®(å«price.plans)
â”‚   â””â”€â”€ price-config.tsx   # âœ… ä» mksaas/src/config/price-config.tsx å¤åˆ¶ - å®šä»·UIæ–‡æ¡ˆ(å¤šè¯­è¨€)
â”‚
â”œâ”€â”€ payment/               # æ”¯ä»˜æ¨¡å— (ä» mksaas/src/payment/ æ•´ä¸ªç›®å½•å¤åˆ¶)
â”‚   â”œâ”€â”€ index.ts           # æ”¯ä»˜æä¾›å•†ç»Ÿä¸€æ¥å£
â”‚   â”œâ”€â”€ types.ts           # ç±»å‹å®šä¹‰(PricePlan, CreateCheckoutParamsç­‰)
â”‚   â””â”€â”€ provider/
â”‚       â””â”€â”€ stripe.ts      # Stripeå®ç°(createCheckout/createCustomerPortal/webhook)
â”‚
â”œâ”€â”€ credits/               # ç§¯åˆ†ç³»ç»Ÿ (ä» mksaas/src/credits/ æ•´ä¸ªç›®å½•å¤åˆ¶,æš‚ä¸å¯ç”¨)
â”‚   â”œâ”€â”€ credits.ts         # ç§¯åˆ†é€»è¾‘
â”‚   â”œâ”€â”€ server.ts          # æœåŠ¡ç«¯API
â”‚   â”œâ”€â”€ client.ts          # å®¢æˆ·ç«¯hooks
â”‚   â”œâ”€â”€ distribute.ts      # ç§¯åˆ†åˆ†å‘
â”‚   â””â”€â”€ types.ts           # ç§¯åˆ†ç±»å‹å®šä¹‰
â”‚
â”œâ”€â”€ db/                    # æ•°æ®åº“ (ä» mksaas/src/db/ æ•´ä¸ªç›®å½•å¤åˆ¶)
â”‚   â”œâ”€â”€ index.ts           # æ•°æ®åº“è¿æ¥(Neon/Supabase PostgreSQL)
â”‚   â”œâ”€â”€ schema.ts          # è¡¨ç»“æ„å®šä¹‰(user, payment, creditsç­‰)
â”‚   â””â”€â”€ migrations/        # Drizzleè¿ç§»è„šæœ¬
â”‚
â”œâ”€â”€ hooks/                 # è‡ªå®šä¹‰hooks
â”‚   â””â”€â”€ use-subscription.ts  # âœ… æ–°å»º - å®¢æˆ·ç«¯è®¢é˜…çŠ¶æ€hook(é€šè¿‡APIè·å–)
â”‚
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ auth/          # è®¤è¯API (better-authè‡ªåŠ¨ç”Ÿæˆ)
â”‚   â”‚   â”‚   â””â”€â”€ [...all]/route.ts
â”‚   â”‚   â”œâ”€â”€ payment/       # æ”¯ä»˜API
â”‚   â”‚   â”‚   â”œâ”€â”€ checkout/route.ts      # åˆ›å»ºcheckout session
â”‚   â”‚   â”‚   â”œâ”€â”€ webhook/route.ts       # Stripe webhookå¤„ç†
â”‚   â”‚   â”‚   â””â”€â”€ portal/route.ts        # å®¢æˆ·é—¨æˆ·è·³è½¬
â”‚   â”‚   â””â”€â”€ subscription/  # è®¢é˜…æŸ¥è¯¢API
â”‚   â”‚       â””â”€â”€ status/route.ts        # è·å–å½“å‰ç”¨æˆ·è®¢é˜…çŠ¶æ€(å«è®¡åˆ’ID)
â”‚   â”‚
â”‚   â”œâ”€â”€ [locale]/          # next-intlå¤šè¯­è¨€è·¯ç”± (ç°æœ‰ç»“æ„)
â”‚   â”‚   â”œâ”€â”€ (auth)/        # è®¤è¯é¡µé¢ç»„
â”‚   â”‚   â”‚   â”œâ”€â”€ login/page.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ register/page.tsx
â”‚   â”‚   â”‚   â””â”€â”€ forgot-password/page.tsx
â”‚   â”‚   â”œâ”€â”€ pricing/       # å®šä»·é¡µ
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”œâ”€â”€ dashboard/     # ç”¨æˆ·ä¸­å¿ƒ
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx            # æ¦‚è§ˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ subscription/page.tsx  # è®¢é˜…ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ settings/page.tsx      # è´¦å·è®¾ç½®
â”‚   â”‚   â””â”€â”€ checkout/      # æ”¯ä»˜ç»“æœé¡µ
â”‚   â”‚       â”œâ”€â”€ success/page.tsx
â”‚   â”‚       â””â”€â”€ cancel/page.tsx
â”‚   â”‚
â”‚   â””â”€â”€ ... (å…¶ä»–ç°æœ‰é¡µé¢)
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ auth/              # è®¤è¯ç»„ä»¶ (ä»mksaaså‚è€ƒæˆ–ä½¿ç”¨better-authå®˜æ–¹UI)
â”‚   â”‚   â”œâ”€â”€ login-form.tsx
â”‚   â”‚   â””â”€â”€ register-form.tsx
â”‚   â”œâ”€â”€ payment/           # æ”¯ä»˜äº¤äº’ç»„ä»¶ (ä» mksaas/src/components/pricing/ å¤åˆ¶)
â”‚   â”‚   â”œâ”€â”€ pricing-card.tsx             # å®šä»·å¡ç‰‡(props: plan, interval)
â”‚   â”‚   â”œâ”€â”€ pricing-table.tsx            # å®šä»·è¡¨æ ¼
â”‚   â”‚   â”œâ”€â”€ create-checkout-button.tsx   # åˆ›å»ºcheckoutæŒ‰é’®
â”‚   â”‚   â””â”€â”€ customer-portal-button.tsx   # å®¢æˆ·é—¨æˆ·æŒ‰é’®
â”‚   â””â”€â”€ ... (å…¶ä»–ç°æœ‰ç»„ä»¶)
â”‚
â”œâ”€â”€ messages/              # å›½é™…åŒ–æ¶ˆæ¯ (ç°æœ‰,éœ€æ‰©å±•)
â”‚   â”œâ”€â”€ en.json            # æ–°å¢: PricePlans, Dashboard, Paymentç›¸å…³æ–‡æ¡ˆ
â”‚   â””â”€â”€ ar.json
â”‚
â””â”€â”€ .env.local             # ç¯å¢ƒå˜é‡(Stripeå¯†é’¥,æ•°æ®åº“è¿æ¥ç­‰)
```

---

## æ–‡ä»¶è¿ç§»æ¸…å•

âš ï¸ **å…³é”®è·¯å¾„è§„åˆ™**:
- mksaasæºè·¯å¾„: `mksaas_template-cloudflare/src/xxx`
- ç›®æ ‡è·¯å¾„: `arabic-calligraphy-creator/xxx` (æ— srcç›®å½•)
- æ‰€æœ‰å¯¼å…¥è·¯å¾„: `@/xxx` (å›  tsconfig.json ä¸­ `@/*` æ˜ å°„åˆ° `./`)

### ç¬¬ä¸€ä¼˜å…ˆçº§: æ ¸å¿ƒåŠŸèƒ½ (å¿…é¡»)

#### 1. è®¤è¯ç³»ç»Ÿ (better-auth)

**æºè·¯å¾„**: `mksaas_template-cloudflare/src/lib/`
**ç›®æ ‡è·¯å¾„**: `arabic-calligraphy-creator/lib/`

```bash
# å¤åˆ¶è®¤è¯æ ¸å¿ƒæ–‡ä»¶
lib/
â”œâ”€â”€ auth.ts               # âœ… å¿…é¡» - better-authæœåŠ¡ç«¯é…ç½®
â”œâ”€â”€ auth-client.ts        # âœ… å¿…é¡» - å®¢æˆ·ç«¯hookså’ŒauthClientå®ä¾‹
â””â”€â”€ urls/
    â””â”€â”€ urls.ts           # âœ… å¿…é¡» - URLå·¥å…·å‡½æ•°(authä¾èµ–)
```

**é…ç½®æ–‡ä»¶**: `mksaas_template-cloudflare/src/config/`

```bash
config/
â””â”€â”€ website.tsx           # âœ… å¿…é¡» - å®Œæ•´å¤åˆ¶,åŒ…å«auth/payment/creditsé…ç½®
```

**ä¿®æ­£åçš„å¯¼å…¥è·¯å¾„è§„åˆ™**:
```typescript
// âœ… æ­£ç¡® - æ‰€æœ‰å¯¼å…¥ä½¿ç”¨ @/ (æ— src)
import { auth } from '@/lib/auth';
import { websiteConfig } from '@/config/website';
import { createCheckout } from '@/payment';

// âŒ é”™è¯¯ - ä¸è¦ä½¿ç”¨ @/src/
import { auth } from '@/src/lib/auth'; // é”™è¯¯!
```

**è¯´æ˜**:
- `lib/auth.ts`: æœåŠ¡ç«¯better-authé…ç½®,å¯¼å‡º `auth` å®ä¾‹,åŒ…å«emailAndPasswordã€OAuthã€sessionç­‰
- `lib/auth-client.ts`: å®¢æˆ·ç«¯authClientå®ä¾‹,ç”¨äºReactç»„ä»¶,å¯¼å‡º `authClient` å’Œ hooks
- `config/website.tsx`: å…¨å±€é…ç½®å¯¹è±¡ `websiteConfig`,åŒ…å« auth/payment/price/features ç­‰

#### 2. æ”¯ä»˜ç³»ç»Ÿ (Stripe)

**æºè·¯å¾„**: `mksaas_template-cloudflare/src/payment/`
**ç›®æ ‡è·¯å¾„**: `arabic-calligraphy-creator/payment/`

```bash
# å¤åˆ¶æ•´ä¸ªpaymentç›®å½•
cp -r mksaas_template-cloudflare/src/payment/ arabic-calligraphy-creator/payment/

# ç›®å½•ç»“æ„
payment/
â”œâ”€â”€ index.ts              # âœ… å¯¼å‡ºç»Ÿä¸€æ¥å£: createCheckout, createCustomerPortal, handleWebhookEvent
â”œâ”€â”€ types.ts              # âœ… ç±»å‹å®šä¹‰: PricePlan, CreateCheckoutParams, Subscriptionç­‰
â”œâ”€â”€ README.md             # æ–‡æ¡£
â””â”€â”€ provider/
    â””â”€â”€ stripe.ts         # âœ… StripeProviderç±»å®ç°,åŒ…å«webhookå¤„ç†
```

**ç›¸å…³é…ç½®å’Œå·¥å…·æ–‡ä»¶**:

```bash
# ä»·æ ¼è®¡åˆ’é…ç½®
config/
â”œâ”€â”€ website.tsx           # âœ… å¿…é¡» - åŒ…å« price.plans å¯¹è±¡(ä¸¥æ ¼ç¬¦åˆPricePlanæ¥å£)
â””â”€â”€ price-config.tsx      # âœ… å¿…é¡» - getPricePlans()å‡½æ•°,å®¢æˆ·ç«¯ä½¿ç”¨,è¿”å›å¸¦ç¿»è¯‘çš„è®¡åˆ’

# ä»·æ ¼è®¡åˆ’å·¥å…·å‡½æ•°
lib/
â””â”€â”€ price-plan.ts         # âœ… å¿…é¡» - getAllPricePlans, findPlanByPriceId, findPriceInPlanç­‰
```

**å…³é”®ç±»å‹å’Œå‡½æ•°**:
```typescript
// payment/types.ts ä¸­çš„æ ¸å¿ƒæ¥å£
export interface PricePlan {
  id: string;
  name?: string;
  description?: string;
  features?: string[];
  limits?: string[];
  prices: Price[];       // å¿…é¡»!å¯ä¸ºç©ºæ•°ç»„(freeè®¡åˆ’)
  isFree: boolean;
  isLifetime: boolean;
  popular?: boolean;
  disabled?: boolean;
  credits?: Credits;
}

export interface CreateCheckoutParams {
  planId: string;
  priceId: string;
  customerEmail: string;
  successUrl?: string;
  cancelUrl?: string;
  metadata?: Record<string, string>;
  locale?: Locale;      // âš ï¸ é‡è¦!ä¼ é€’ç»™Stripe
}

// payment/index.ts å¯¼å‡ºçš„ç»Ÿä¸€API
export const createCheckout = async (params: CreateCheckoutParams): Promise<CheckoutResult>
export const createCustomerPortal = async (params: CreatePortalParams): Promise<PortalResult>
```

**è¯´æ˜**:
- `config/website.tsx` çš„ `price.plans` å¯¹è±¡å¿…é¡»ä¸¥æ ¼ç¬¦åˆ `PricePlan` æ¥å£,ä¸åŒ…å«UIæ–‡æ¡ˆ
- `config/price-config.tsx` çš„ `getPricePlans()` åœ¨å®¢æˆ·ç«¯ä½¿ç”¨,åˆå¹¶ `website.tsx` é…ç½®å’Œ i18n ç¿»è¯‘æ–‡æ¡ˆ
- `lib/price-plan.ts` æä¾›æœåŠ¡ç«¯æŸ¥è¯¢å·¥å…·,ç›´æ¥è¯»å– `website.tsx` é…ç½®
- æ‰€æœ‰å¯¼å…¥è·¯å¾„: `@/payment`, `@/config/website`, `@/lib/price-plan`

#### 3. æ•°æ®åº“

**æºè·¯å¾„**: `mksaas_template-cloudflare/src/db/`

```bash
db/                       # âœ… æ•´ä¸ªç›®å½•å¤åˆ¶
â”œâ”€â”€ index.ts              # æ•°æ®åº“è¿æ¥
â”œâ”€â”€ schema.ts             # è¡¨ç»“æ„(éœ€è¦è°ƒæ•´ä»¥é€‚é…é¡¹ç›®)
â””â”€â”€ migrations/           # è¿ç§»è„šæœ¬(æ‰§è¡Œåç”Ÿæˆ)
    â””â”€â”€ 0000_*.sql
```

**ä¾èµ–åŒ…**:

```bash
# éœ€è¦å®‰è£…çš„npmåŒ…
npm install drizzle-orm drizzle-kit @neondatabase/serverless postgres
```

**âš ï¸ é‡è¦**: 
- `db/schema.ts`éœ€è¦ä¿ç•™mksaasçš„æ‰€æœ‰è¡¨ç»“æ„
- å¦‚æœé¡¹ç›®å·²æœ‰å…¶ä»–è¡¨,éœ€è¦åˆå¹¶åˆ°åŒä¸€ä¸ªschemaæ–‡ä»¶
- è¿ç§»è„šæœ¬é€šè¿‡`drizzle-kit generate`ç”Ÿæˆ

### ç¬¬äºŒä¼˜å…ˆçº§: ç§¯åˆ†ç³»ç»Ÿ (é¢„ç•™)

**æºè·¯å¾„**: `mksaas_template-cloudflare/src/credits/`

```bash
credits/                  # âœ… æ•´ä¸ªç›®å½•å¤åˆ¶
â”œâ”€â”€ credits.ts            # æ ¸å¿ƒé€»è¾‘(FIFOç§¯åˆ†æ¶ˆè€—ã€è¿‡æœŸå¤„ç†)
â”œâ”€â”€ server.ts             # æœåŠ¡ç«¯API
â”œâ”€â”€ client.ts             # å®¢æˆ·ç«¯hooks
â”œâ”€â”€ distribute.ts         # ç§¯åˆ†åˆ†å‘(æ³¨å†Œå¥–åŠ±ã€æœˆåº¦å¥–åŠ±ç­‰)
â”œâ”€â”€ types.ts              # ç±»å‹å®šä¹‰
â””â”€â”€ README.md             # æ–‡æ¡£
```

**é…ç½®æ–‡ä»¶**:

```bash
config/
â””â”€â”€ credits-config.tsx    # âš ï¸ å¯é€‰ - ç§¯åˆ†åŒ…å®šä»·é…ç½®
```

**è¯´æ˜**: 
- å½“å‰ä¸ç”¨ç§¯åˆ†,ä½†**å¼ºçƒˆå»ºè®®å¤åˆ¶**,å› ä¸º:
  1. æ•°æ®åº“schemaå·²åŒ…å«ç§¯åˆ†è¡¨
  2. æœªæ¥å¯èƒ½éœ€è¦ç§¯åˆ†è´­ä¹°ã€APIè®¡è´¹ç­‰
  3. å¤åˆ¶æˆæœ¬ä½,ä¸å½±å“ç°æœ‰åŠŸèƒ½
- ä¸éœ€è¦å®ç°UI,ä¿ç•™ä»£ç å³å¯

### ç¬¬ä¸‰ä¼˜å…ˆçº§: UIç»„ä»¶

#### è®¤è¯ç»„ä»¶

**æºè·¯å¾„**: `mksaas_template-cloudflare/src/components/auth/`

```bash
components/auth/
â”œâ”€â”€ login-form.tsx            # âœ… ç™»å½•è¡¨å•
â”œâ”€â”€ register-form.tsx         # âœ… æ³¨å†Œè¡¨å•
â”œâ”€â”€ forgot-password-form.tsx  # âš ï¸ å¯é€‰
â”œâ”€â”€ reset-password-form.tsx   # âš ï¸ å¯é€‰
â”œâ”€â”€ social-login-button.tsx   # âš ï¸ å¯é€‰(OAuthæŒ‰é’®)
â””â”€â”€ login-wrapper.tsx         # âš ï¸ å¯é€‰(ç»Ÿä¸€å¸ƒå±€)
```

#### å®šä»·/æ”¯ä»˜ç»„ä»¶

**æºè·¯å¾„**: `mksaas_template-cloudflare/src/components/pricing/`

```bash
components/pricing/
â”œâ”€â”€ create-checkout-button.tsx    # âœ… Stripe checkoutè§¦å‘æŒ‰é’®
â”œâ”€â”€ customer-portal-button.tsx    # âœ… Stripeå®¢æˆ·é—¨æˆ·å…¥å£
â”œâ”€â”€ pricing-card.tsx              # âœ… å®šä»·å¡ç‰‡å±•ç¤º
â””â”€â”€ pricing-table.tsx             # âš ï¸ å¯é€‰ - è¡¨æ ¼æ ·å¼å®šä»·å±•ç¤º
```

### é…ç½®æ–‡ä»¶æ¸…å•

#### ç¯å¢ƒå˜é‡ (.env.local)

```bash
# ====================================
# æ•°æ®åº“
# ====================================
DATABASE_URL="postgresql://..."

# ====================================
# Better Auth
# ====================================
BETTER_AUTH_SECRET="random-secret-string"
BETTER_AUTH_URL="http://localhost:3000" # å¼€å‘ç¯å¢ƒ
# BETTER_AUTH_URL="https://arabic-calligraphy-generator.com" # ç”Ÿäº§ç¯å¢ƒ

# ====================================
# OAuth (å¯é€‰)
# ====================================
# Google OAuth
GOOGLE_CLIENT_ID="your-google-client-id"
GOOGLE_CLIENT_SECRET="your-google-client-secret"

# GitHub OAuth
GITHUB_CLIENT_ID="your-github-client-id"
GITHUB_CLIENT_SECRET="your-github-client-secret"

# ====================================
# Stripe
# ====================================
STRIPE_SECRET_KEY="sk_test_..."
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_..."
STRIPE_WEBHOOK_SECRET="whsec_..."

# Stripeä»·æ ¼ID (åœ¨Stripe Dashboardåˆ›å»ºåå¡«å…¥)
STRIPE_PRICE_ID_PRO_MONTHLY="price_..."
STRIPE_PRICE_ID_PRO_YEARLY="price_..."

# ====================================
# é‚®ä»¶ (å¯é€‰ - ç”¨äºå¯†ç é‡ç½®ç­‰)
# ====================================
RESEND_API_KEY="re_..."
EMAIL_FROM="noreply@arabic-calligraphy-generator.com"
```

#### package.jsonä¾èµ–

éœ€è¦æ·»åŠ çš„ä¾èµ–:

```json
{
  "dependencies": {
    "better-auth": "^0.x.x",
    "drizzle-orm": "^0.x.x",
    "stripe": "^14.x.x",
    "@neondatabase/serverless": "^0.x.x",
    "date-fns": "^3.x.x",
    "resend": "^3.x.x"
  },
  "devDependencies": {
    "drizzle-kit": "^0.x.x"
  }
}
```

---

## æ•°æ®åº“è®¾è®¡

### Schemaå®šä¹‰

**æ–‡ä»¶**: `db/schema.ts` (ä»mksaaså¤åˆ¶å¹¶è°ƒæ•´)

```typescript
import { boolean, integer, pgTable, text, timestamp, index } from "drizzle-orm/pg-core";

// ====================================
// ç”¨æˆ·è¡¨
// ====================================
export const user = pgTable("user", {
  id: text("id").primaryKey(),
  name: text('name').notNull(),
  email: text('email').notNull().unique(),
  emailVerified: boolean('email_verified').notNull(),
  image: text('image'),
  createdAt: timestamp('created_at').notNull(),
  updatedAt: timestamp('updated_at').notNull(),
  role: text('role'), // 'user' | 'admin'
  banned: boolean('banned'),
  banReason: text('ban_reason'),
  banExpires: timestamp('ban_expires'),
  customerId: text('customer_id'), // Stripe customer ID
}, (table) => ({
  userIdIdx: index("user_id_idx").on(table.id),
  userCustomerIdIdx: index("user_customer_id_idx").on(table.customerId),
  userEmailIdx: index("user_email_idx").on(table.email),
}));

// ====================================
// ä¼šè¯è¡¨
// ====================================
export const session = pgTable("session", {
  id: text("id").primaryKey(),
  expiresAt: timestamp('expires_at').notNull(),
  token: text('token').notNull().unique(),
  createdAt: timestamp('created_at').notNull(),
  updatedAt: timestamp('updated_at').notNull(),
  ipAddress: text('ip_address'),
  userAgent: text('user_agent'),
  userId: text('user_id').notNull().references(() => user.id, { onDelete: 'cascade' }),
}, (table) => ({
  sessionTokenIdx: index("session_token_idx").on(table.token),
  sessionUserIdIdx: index("session_user_id_idx").on(table.userId),
}));

// ====================================
// OAuthè´¦å·è¡¨
// ====================================
export const account = pgTable("account", {
  id: text("id").primaryKey(),
  accountId: text('account_id').notNull(),
  providerId: text('provider_id').notNull(), // 'google' | 'github' | 'credential'
  userId: text('user_id').notNull().references(() => user.id, { onDelete: 'cascade' }),
  accessToken: text('access_token'),
  refreshToken: text('refresh_token'),
  idToken: text('id_token'),
  accessTokenExpiresAt: timestamp('access_token_expires_at'),
  refreshTokenExpiresAt: timestamp('refresh_token_expires_at'),
  scope: text('scope'),
  password: text('password'), // å¯†ç å“ˆå¸Œ
  createdAt: timestamp('created_at').notNull(),
  updatedAt: timestamp('updated_at').notNull()
}, (table) => ({
  accountUserIdIdx: index("account_user_id_idx").on(table.userId),
  accountProviderIdIdx: index("account_provider_id_idx").on(table.providerId),
}));

// ====================================
// éªŒè¯ç è¡¨ (ç”¨äºé‚®ç®±éªŒè¯ã€å¯†ç é‡ç½®)
// ====================================
export const verification = pgTable("verification", {
  id: text("id").primaryKey(),
  identifier: text('identifier').notNull(), // email
  value: text('value').notNull(), // code
  expiresAt: timestamp('expires_at').notNull(),
  createdAt: timestamp('created_at'),
  updatedAt: timestamp('updated_at')
});

// ====================================
// æ”¯ä»˜/è®¢é˜…è¡¨
// ====================================
export const payment = pgTable("payment", {
  id: text("id").primaryKey(),
  priceId: text('price_id').notNull(), // Stripe price ID
  type: text('type').notNull(), // 'subscription' | 'one_time'
  interval: text('interval'), // 'month' | 'year' | null
  userId: text('user_id').notNull().references(() => user.id, { onDelete: 'cascade' }),
  customerId: text('customer_id').notNull(), // Stripe customer ID
  subscriptionId: text('subscription_id'), // Stripe subscription ID
  sessionId: text('session_id'), // Stripe checkout session ID
  status: text('status').notNull(), // 'active' | 'canceled' | 'past_due' | 'incomplete'
  periodStart: timestamp('period_start'),
  periodEnd: timestamp('period_end'),
  cancelAtPeriodEnd: boolean('cancel_at_period_end'),
  trialStart: timestamp('trial_start'),
  trialEnd: timestamp('trial_end'),
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at').notNull().defaultNow(),
}, (table) => ({
  paymentTypeIdx: index("payment_type_idx").on(table.type),
  paymentUserIdIdx: index("payment_user_id_idx").on(table.userId),
  paymentStatusIdx: index("payment_status_idx").on(table.status),
  paymentSubscriptionIdIdx: index("payment_subscription_id_idx").on(table.subscriptionId),
}));

// ====================================
// ç§¯åˆ†è¡¨ (é¢„ç•™)
// ====================================
export const userCredit = pgTable("user_credit", {
  id: text("id").primaryKey(),
  userId: text("user_id").notNull().references(() => user.id, { onDelete: 'cascade' }),
  currentCredits: integer("current_credits").notNull().default(0),
  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
}, (table) => ({
  userCreditUserIdIdx: index("user_credit_user_id_idx").on(table.userId),
}));

// ====================================
// ç§¯åˆ†äº¤æ˜“è®°å½•è¡¨ (é¢„ç•™)
// ====================================
export const creditTransaction = pgTable("credit_transaction", {
  id: text("id").primaryKey(),
  userId: text("user_id").notNull().references(() => user.id, { onDelete: 'cascade' }),
  type: text("type").notNull(), // 'earn' | 'spend'
  description: text("description"),
  amount: integer("amount").notNull(), // æ­£æ•°=è·å¾—, è´Ÿæ•°=æ¶ˆè€—
  remainingAmount: integer("remaining_amount"),
  paymentId: text("payment_id"),
  expirationDate: timestamp("expiration_date"),
  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
}, (table) => ({
  creditTransactionUserIdIdx: index("credit_transaction_user_id_idx").on(table.userId),
  creditTransactionTypeIdx: index("credit_transaction_type_idx").on(table.type),
}));
```

### æ•°æ®åº“è¿ç§»

```bash
# 1. å®‰è£…ä¾èµ–
npm install drizzle-orm drizzle-kit @neondatabase/serverless

# 2. åˆ›å»ºdrizzle.config.ts
echo "
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'postgresql',
  schema: './db/schema.ts',
  out: './db/migrations',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
" > drizzle.config.ts

# 3. ç”Ÿæˆè¿ç§»
npx drizzle-kit generate

# 4. æ‰§è¡Œè¿ç§»
npx drizzle-kit migrate

# 5. æŸ¥çœ‹æ•°æ®åº“
npx drizzle-kit studio
```

---

## æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. è®¤è¯ç³»ç»Ÿ

#### better-authé…ç½®

âš ï¸ **è·¯å¾„ä¿®æ­£**: ä½¿ç”¨ `lib/auth.ts` è€Œä¸æ˜¯ `src/auth/index.ts`

**æ–‡ä»¶**: `lib/auth.ts` (ä»mksaaså¤åˆ¶,å·²åŒ…å«å®Œæ•´é…ç½®)

è¿™ä¸ªæ–‡ä»¶å·²ç»åŒ…å«:
- âœ… Drizzle adapteré…ç½®
- âœ… Email/Passwordè®¤è¯
- âœ… OAuth (Google, GitHub)  
- âœ… é‚®ç®±éªŒè¯
- âœ… Sessionç®¡ç†
- âœ… å›½é™…åŒ–æ”¯æŒ
- âœ… æ–°ç”¨æˆ·æ³¨å†Œå¥–åŠ±(ç§¯åˆ†)

**æ— éœ€ä¿®æ”¹**,ç›´æ¥å¤åˆ¶ä½¿ç”¨ã€‚

#### å®¢æˆ·ç«¯Hooks

**æ–‡ä»¶**: `lib/auth-client.ts` (ä»mksaaså¤åˆ¶)

```typescript
import { createAuthClient } from 'better-auth/react';
import { getBaseUrl } from './urls/urls';

export const authClient = createAuthClient({
  baseURL: getBaseUrl(),
});
```

**ä½¿ç”¨æ–¹å¼**:
```typescript
// åœ¨Reactç»„ä»¶ä¸­
import { authClient } from '@/lib/auth-client';

const { data: session } = authClient.useSession();
const { signOut } = authClient;
```

#### APIè·¯ç”±

**æ–‡ä»¶**: `app/api/auth/[...all]/route.ts`

```typescript
import { auth } from "@/lib/auth";
import { toNextJsHandler } from "better-auth/next-js";

export const { GET, POST } = toNextJsHandler(auth);
```

âš ï¸ **æ³¨æ„**: å¯¼å…¥è·¯å¾„æ”¹ä¸º `@/lib/auth`

### 2. æ”¯ä»˜ç³»ç»Ÿ

#### Stripeé…ç½®

**æ–‡ä»¶**: `payment/provider/stripe.ts` (ä»mksaaså¤åˆ¶)

ä¸»è¦å®ç°:
- `createCheckout()` - åˆ›å»ºè®¢é˜…checkout
- `handleWebhookEvent()` - å¤„ç†webhook
- `createCustomerPortal()` - å®¢æˆ·ç®¡ç†é—¨æˆ·
- `cancelSubscription()` - å–æ¶ˆè®¢é˜…

#### è®¢é˜…è®¡åˆ’é…ç½®

âš ï¸ **è·¯å¾„ä¿®æ­£**: è®¢é˜…è®¡åˆ’é…ç½®åœ¨ `config/website.tsx` çš„ `price.plans` å¯¹è±¡ä¸­,ä¸æ˜¯ç‹¬ç«‹æ–‡ä»¶

**æ–‡ä»¶**: `config/website.tsx` (ä»mksaaså¤åˆ¶åè°ƒæ•´)

```typescript
import { PaymentTypes, PlanIntervals } from '@/payment/types';
import type { WebsiteConfig } from '@/types';

export const websiteConfig: WebsiteConfig = {
  // ... å…¶ä»–é…ç½® ...
  
  price: {
    plans: {
      // Freeè®¡åˆ’ - å¿…é¡»åŒ…å«isFreeå’Œpriceså±æ€§
      free: {
        id: 'free',
        prices: [],                    // Freeè®¡åˆ’pricesä¸ºç©ºæ•°ç»„
        isFree: true,
        isLifetime: false,
        credits: {                     // é¢„ç•™ç§¯åˆ†é…ç½®
          enable: false,               // å½“å‰ä¸å¯ç”¨
          amount: 0,
          expireDays: 30,
        },
      },
      
      // Proè®¡åˆ’ - å¹´ä»˜ä¸»æ¨
      pro: {
        id: 'pro',
        prices: [
          {
            type: PaymentTypes.SUBSCRIPTION,
            priceId: process.env.NEXT_PUBLIC_STRIPE_PRICE_PRO_YEARLY!,
            amount: 2999,              // $29.99 = 2999 cents
            currency: 'USD',
            interval: PlanIntervals.YEAR,
          },
        ],
        isFree: false,
        isLifetime: false,
        popular: true,                 // åœ¨UIä¸Šæ ‡è®°ä¸ºæ¨è
        credits: {
          enable: false,               // å½“å‰ä¸å¯ç”¨
          amount: 0,
          expireDays: 30,
        },
      },
      
      // Ultraè®¡åˆ’ (é¢„ç•™,å¯æš‚æ—¶disabled)
      ultra: {
        id: 'ultra',
        prices: [
          {
            type: PaymentTypes.SUBSCRIPTION,
            priceId: process.env.NEXT_PUBLIC_STRIPE_PRICE_ULTRA_YEARLY || '',
            amount: 4999,              // $49.99
            currency: 'USD',
            interval: PlanIntervals.YEAR,
          },
        ],
        isFree: false,
        isLifetime: false,
        disabled: true,                // æš‚ä¸å¯ç”¨
        credits: {
          enable: false,
          amount: 0,
          expireDays: 30,
        },
      },
    },
  },
  
  },
};
```

**UIæ–‡æ¡ˆé…ç½®**: `config/price-config.tsx` (ä»mksaaså¤åˆ¶åè°ƒæ•´)

```typescript
'use client';
import { useTranslations } from 'next-intl';
import { websiteConfig } from './website';
import type { PricePlan } from '@/payment/types';

/**
 * è·å–å¸¦ç¿»è¯‘çš„ä»·æ ¼è®¡åˆ’(ä»…ç”¨äºå®¢æˆ·ç«¯ç»„ä»¶)
 * æœåŠ¡ç«¯è¯·ä½¿ç”¨ lib/price-plan.ts çš„ getAllPricePlans()
 */
export function getPricePlans(): Record<string, PricePlan> {
  const t = useTranslations('PricePlans');
  const priceConfig = websiteConfig.price;
  const plans: Record<string, PricePlan> = {};

  // Freeè®¡åˆ’
  if (priceConfig.plans.free) {
    plans.free = {
      ...priceConfig.plans.free,
      name: t('free.name'),
      description: t('free.description'),
      features: [
        t('free.features.unlimited-png'),
        t('free.features.basic-fonts'),
        t('free.features.watermark'),
      ],
      limits: [
        t('free.limits.no-svg'),
        t('free.limits.low-resolution'),
      ],
    };
  }

  // Proè®¡åˆ’
  if (priceConfig.plans.pro) {
    plans.pro = {
      ...priceConfig.plans.pro,
      name: t('pro.name'),
      description: t('pro.description'),
      features: [
        t('pro.features.unlimited-downloads'),
        t('pro.features.all-fonts'),
        t('pro.features.high-resolution'),
        t('pro.features.no-watermark'),
        t('pro.features.commercial-use'),
      ],
    };
  }

  return plans;
}
```

**i18næ¶ˆæ¯ç¤ºä¾‹** (messages/en.json):
```json
{
  "PricePlans": {
    "free": {
      "name": "Free",
      "description": "Perfect for personal projects",
      "features": {
        "unlimited-png": "Unlimited PNG downloads",
        "basic-fonts": "5-8 basic fonts",
        "watermark": "Watermarked outputs"
      },
      "limits": {
        "no-svg": "No SVG export",
        "low-resolution": "72 DPI only"
      }
    },
    "pro": {
      "name": "Pro",
      "description": "For professional & commercial use",
      "features": {
        "unlimited-downloads": "Unlimited PNG & SVG downloads",
        "all-fonts": "Access to all 17+ fonts",
        "high-resolution": "High-resolution (300 DPI)",
        "no-watermark": "No watermarks",
        "commercial-use": "Commercial use license"
      }
    }
  }
}
```

#### APIè·¯ç”±å®ç°

**æ–‡ä»¶**: `app/api/payment/checkout/route.ts`

âš ï¸ **å…³é”®ä¿®æ­£**: 
1. å¯¼å…¥è·¯å¾„æ”¹ä¸º `@/lib/auth`
2. **è¡¥é½å¿…éœ€å‚æ•° `planId` å’Œ `customerEmail`**
3. æ”¯æŒnext-intlçš„locale,ä¼ é€’ç»™Stripeå’Œè¿”å›URL

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createCheckout } from '@/payment';
import { auth } from '@/lib/auth';
import { findPlanByPriceId } from '@/lib/price-plan';

export async function POST(req: NextRequest) {
  try {
    // éªŒè¯ç”¨æˆ·ç™»å½•
    const session = await auth.api.getSession({ 
      headers: req.headers 
    });
    
    if (!session?.user) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      );
    }

    const { priceId } = await req.json();
    
    // æ ¹æ®priceIdæŸ¥æ‰¾å¯¹åº”çš„planId (âš ï¸ å¿…éœ€!)
    const plan = findPlanByPriceId(priceId);
    if (!plan) {
      return NextResponse.json(
        { error: 'Invalid price ID' },
        { status: 400 }
      );
    }

    // è·å–å½“å‰locale(ç”¨äºè¿”å›URLå’ŒStripe UI)
    const locale = req.headers.get('x-locale') || 'en';

    // åˆ›å»ºcheckout session - è¡¥é½æ‰€æœ‰å¿…éœ€å‚æ•°
    const result = await createCheckout({
      planId: plan.id,                    // âœ… å¿…éœ€!ä¼ metadataåˆ°Stripe
      priceId,
      customerEmail: session.user.email,   // âœ… å¿…éœ€!ç”¨äºæŸ¥æ‰¾/åˆ›å»ºStripe customer
      locale,                              // âœ… ä¼ é€’ç»™Stripe UI(æ”¯ä»˜é¡µé¢è¯­è¨€)
      successUrl: `${req.nextUrl.origin}/${locale}/checkout/success`, // âœ… å¸¦localeå‰ç¼€
      cancelUrl: `${req.nextUrl.origin}/${locale}/pricing`,
    });

    return NextResponse.json(result);
  } catch (error) {
    console.error('Checkout error:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

**æ–‡ä»¶**: `app/api/payment/webhook/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { handleWebhookEvent } from '@/payment';

export async function POST(req: NextRequest) {
  try {
    const body = await req.text();
    const signature = req.headers.get('stripe-signature')!;

    await handleWebhookEvent(body, signature);

    return NextResponse.json({ received: true });
  } catch (error) {
    console.error('Webhook error:', error);
    return NextResponse.json(
      { error: 'Webhook handler failed' },
      { status: 400 }
    );
  }
}
```

**æ–‡ä»¶**: `app/api/payment/portal/route.ts` (å®¢æˆ·é—¨æˆ·è·³è½¬)

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createCustomerPortal } from '@/payment';
import { auth } from '@/lib/auth';

export async function POST(req: NextRequest) {
  try {
    const session = await auth.api.getSession({ 
      headers: req.headers 
    });
    
    if (!session?.user?.customerId) {
      return NextResponse.json(
        { error: 'No customer found' },
        { status: 400 }
      );
    }

    const locale = req.headers.get('x-locale') || 'en';

    const result = await createCustomerPortal({
      customerId: session.user.customerId,
      returnUrl: `${req.nextUrl.origin}/${locale}/dashboard/subscription`, // âœ… å¸¦locale
      locale,  // âœ… å®¢æˆ·é—¨æˆ·UIè¯­è¨€
    });

    return NextResponse.json(result);
  } catch (error) {
    console.error('Portal error:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

### 3. æƒé™æ§åˆ¶

#### æœåŠ¡ç«¯è®¢é˜…çŠ¶æ€æ£€æŸ¥

âš ï¸ **å…³é”®ä¿®æ­£**: 
1. **è¿™äº›å‡½æ•°åªèƒ½åœ¨æœåŠ¡ç«¯(Server Component/API Route/Server Action)ä½¿ç”¨**
2. **å®¢æˆ·ç«¯ç»„ä»¶ä¸èƒ½ç›´æ¥è°ƒç”¨**,éœ€é€šè¿‡API endpointæˆ–hook

**æ–‡ä»¶**: `lib/subscription.ts` (æ–°å»º,æœåŠ¡ç«¯ä¸“ç”¨)

```typescript
'use server';

import { getDb } from '@/db';
import { payment } from '@/db/schema';
import { and, eq } from 'drizzle-orm';

/**
 * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰Proè®¢é˜…
 * @server-only - åªèƒ½åœ¨æœåŠ¡ç«¯è°ƒç”¨
 */
export async function hasProSubscription(userId: string): Promise<boolean> {
  const db = await getDb();
  
  const subscription = await db
    .select()
    .from(payment)
    .where(
      and(
        eq(payment.userId, userId),
        eq(payment.type, 'subscription'),
        eq(payment.status, 'active')
      )
    )
    .limit(1);
    
  return subscription.length > 0;
}

/**
 * è·å–ç”¨æˆ·è®¢é˜…ä¿¡æ¯
 * @server-only - åªèƒ½åœ¨æœåŠ¡ç«¯è°ƒç”¨
 */
export async function getUserSubscription(userId: string) {
  const db = await getDb();
  
  const subscription = await db
    .select()
    .from(payment)
    .where(
      and(
        eq(payment.userId, userId),
        eq(payment.type, 'subscription'),
        eq(payment.status, 'active')
      )
    )
    .limit(1);
    
  return subscription[0] || null;
}

/**
 * è·å–ç”¨æˆ·è®¢é˜…çŠ¶æ€ (ä¾›å®¢æˆ·ç«¯ä½¿ç”¨çš„API)
 * å®¢æˆ·ç«¯é€šè¿‡fetchè°ƒç”¨è¿™ä¸ªAPI
 */
export async function getSubscriptionStatus(userId: string) {
  const subscription = await getUserSubscription(userId);
  return {
    isPro: !!subscription,
    subscription: subscription ? {
      status: subscription.status,
      periodEnd: subscription.periodEnd,
      cancelAtPeriodEnd: subscription.cancelAtPeriodEnd,
    } : null,
  };
}
```

**å®¢æˆ·ç«¯ä½¿ç”¨æ–¹å¼** (é€šè¿‡API):

**æ–‡ä»¶**: `app/api/subscription/status/route.ts` (æ–°å»º)

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { getSubscriptionStatus } from '@/lib/subscription';

export async function GET(req: NextRequest) {
  try {
    const session = await auth.api.getSession({ 
      headers: req.headers 
    });
    
    if (!session?.user) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      );
    }

    const status = await getSubscriptionStatus(session.user.id);
    return NextResponse.json(status);
  } catch (error) {
    console.error('Get subscription status error:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

**å®¢æˆ·ç«¯ä½¿ç”¨ - è‡ªå®šä¹‰Hook**:

**æ–‡ä»¶**: `hooks/use-subscription.ts` (æ–°å»º)

```typescript
'use client';

import { useState, useEffect } from 'react';
import { authClient } from '@/lib/auth-client';

export interface SubscriptionStatus {
  isPro: boolean;
  planId?: string;
  subscription?: {
    status: string;
    periodEnd?: Date;
    cancelAtPeriodEnd?: boolean;
  } | null;
}

/**
 * å®¢æˆ·ç«¯è®¢é˜…çŠ¶æ€hook - é€šè¿‡APIè·å–
 */
export function useSubscriptionStatus() {
  const [status, setStatus] = useState<SubscriptionStatus>({
    isPro: false,
    subscription: null,
  });
  const [loading, setLoading] = useState(true);
  
  const { data: session } = authClient.useSession();

  useEffect(() => {
    async function fetchStatus() {
      if (!session?.user) {
        setStatus({ isPro: false, subscription: null });
        setLoading(false);
        return;
      }
      
      try {
        const res = await fetch('/api/subscription/status');
        if (res.ok) {
          const data = await res.json();
          setStatus(data);
        }
      } catch (error) {
        console.error('Failed to fetch subscription status:', error);
      } finally {
        setLoading(false);
      }
    }
    
    fetchStatus();
  }, [session]);

  return { ...status, loading };
}
```

#### SVGä¸‹è½½æ”¹é€ 

âš ï¸ **å…³é”®ä¿®æ­£**: 
1. å¯¼å…¥è·¯å¾„æ”¹ä¸º `@/lib/auth-client`
2. ä½¿ç”¨ `useSubscriptionStatus` hook (é€šè¿‡API)
3. ä½¿ç”¨ next-intl çš„è·¯ç”±

**æ–‡ä»¶**: `components/calligraphy-generator.tsx` (ä¿®æ”¹ç°æœ‰æ–‡ä»¶)

```typescript
'use client';

// åœ¨ç°æœ‰æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥
import { authClient } from '@/lib/auth-client';
import { useSubscriptionStatus } from '@/hooks/use-subscription'; // è‡ªå®šä¹‰hook
import { useRouter } from 'next/navigation';
import { useLocale } from 'next-intl';

export function CalligraphyGenerator({ ... }) {
  // ä½¿ç”¨authClientçš„hooks
  const { data: session } = authClient.useSession();
  const router = useRouter();
  const locale = useLocale();
  
  // è·å–è®¢é˜…çŠ¶æ€
  const { isPro, loading: subscriptionLoading } = useSubscriptionStatus();
  
  const [showUpgradeModal, setShowUpgradeModal] = useState(false);

  const handleDownloadSVG = async () => {
    // 1. æ£€æŸ¥ç™»å½•çŠ¶æ€
    if (!session?.user) {
      toast({
        title: t('toasts.loginRequired'),
        description: t('toasts.loginRequiredDesc'),
      });
      
      // âœ… ä½¿ç”¨next-intl Linkå’Œå½“å‰localeè·³è½¬
      const currentPath = window.location.pathname;
      router.push(`/${locale}/login?redirect=${encodeURIComponent(currentPath)}`);
      return;
    }

    // 2. æ£€æŸ¥Proè®¢é˜… (ä»hookè·å–)
    if (!isPro) {
      setShowUpgradeModal(true);
      return;
    }

    // 3. Proç”¨æˆ·,æ‰§è¡ŒSVGä¸‹è½½
    try {
      toast({
        title: t('toasts.downloadStarted'),
        description: t('toasts.preparingSVG'),
      });

      // ... åŸæœ‰SVGç”Ÿæˆå’Œä¸‹è½½é€»è¾‘ ...

      toast({
        title: t('toasts.downloadComplete'),
        description: t('toasts.downloadCompleteSVG'),
      });
    } catch (error) {
      console.error('SVG download failed:', error);
      toast({
        title: t('toasts.downloadFailed'),
        description: t('toasts.downloadError'),
        variant: "destructive",
      });
    }
  };

  // å‡çº§æç¤ºå¼¹çª—
  const renderUpgradeModal = () => (
    <Dialog open={showUpgradeModal} onOpenChange={setShowUpgradeModal}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>{t('upgrade.title')}</DialogTitle>
          <DialogDescription>
            {t('upgrade.description')}
          </DialogDescription>
        </DialogHeader>
        <div className="flex justify-end gap-2 mt-4">
          <Button variant="outline" onClick={() => setShowUpgradeModal(false)}>
            {t('upgrade.cancel')}
          </Button>
          <Button onClick={() => router.push(`/${locale}/pricing`)}>
            {t('upgrade.viewPricing')}
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );

  return (
    <div>
      {/* åŸæœ‰UI */}
      {renderUpgradeModal()}
    <>
      {/* åŸæœ‰ç»„ä»¶å†…å®¹ */}
      
      {/* å‡çº§æç¤ºModal */}
      {showUpgradeModal && (
        <Dialog open={showUpgradeModal} onOpenChange={setShowUpgradeModal}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>å‡çº§åˆ°Proè§£é”SVGä¸‹è½½</DialogTitle>
              <DialogDescription>
                SVGæ ¼å¼æ”¯æŒæ— é™ç¼©æ”¾,é€‚åˆä¸“ä¸šè®¾è®¡å’Œæ‰“å°
              </DialogDescription>
            </DialogHeader>
            
            <div className="space-y-4">
              <div className="bg-amber-50 p-4 rounded-lg">
                <h4 className="font-semibold mb-2">Proä¼šå‘˜ç‰¹æƒ</h4>
                <ul className="space-y-2 text-sm">
                  <li>âœ… æ— é™SVG/PNGä¸‹è½½</li>
                  <li>âœ… æ‰€æœ‰17+å­—ä½“</li>
                  <li>âœ… é«˜æ¸…300 DPI</li>
                  <li>âœ… æ— æ°´å°</li>
                  <li>âœ… å•†ç”¨æˆæƒ</li>
                </ul>
              </div>
              
              <div className="text-center">
                <p className="text-2xl font-bold text-amber-600">
                  $29.99/å¹´
                </p>
                <p className="text-sm text-gray-500">
                  ä»…$2.5/æœˆ,éšæ—¶å–æ¶ˆ
                </p>
              </div>
            </div>
            
            <DialogFooter>
              <Button variant="outline" onClick={() => setShowUpgradeModal(false)}>
                ç»§ç»­ä½¿ç”¨å…è´¹ç‰ˆ
              </Button>
              <Button asChild className="bg-amber-600 hover:bg-amber-700">
                <Link href="/pricing">
                  å‡çº§åˆ°Pro
                </Link>
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      )}
    </>
  );
}
```

#### PNGä¸‹è½½ - æ·»åŠ æ°´å°

âš ï¸ **å…³é”®**: ä½¿ç”¨hookè·å–çš„è®¢é˜…çŠ¶æ€,ä¸åœ¨å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨æ•°æ®åº“å‡½æ•°

**æ–‡ä»¶**: `components/calligraphy-generator.tsx` (ä¿®æ”¹)

```typescript
const handleDownloadPNG = async () => {
  // âœ… ä»hookè·å–è®¢é˜…çŠ¶æ€(å·²ç»åœ¨ç»„ä»¶ä¸­å®šä¹‰)
  // const { isPro } = useSubscriptionStatus();
  
  // ç”Ÿæˆcanvas
  const canvas = await generatePreviewCanvas(previewRef.current, currentOptions, 4);
  
  // å¦‚æœä¸æ˜¯Proç”¨æˆ·,æ·»åŠ æ°´å°
  if (!isPro) {
    const ctx = canvas.getContext('2d');
    if (ctx) {
      // æ·»åŠ åŠé€æ˜æ°´å°
      ctx.globalAlpha = 0.3;
      ctx.font = '24px Arial';
      ctx.fillStyle = '#666666';
      ctx.textAlign = 'center';
      ctx.fillText('arabic-calligraphy-generator.com', canvas.width / 2, canvas.height - 30);
      ctx.globalAlpha = 1.0;
    }
  }
  
  // ä¸‹è½½
  const dataUrl = canvas.toDataURL('image/png', 1.0);
  // ...
};
```

---

## å®æ–½æ­¥éª¤

### Phase 1: ç¯å¢ƒå‡†å¤‡ (1å¤©)

#### 1.1 æ•°æ®åº“é…ç½®

```bash
# 1. æ³¨å†ŒNeonè´¦å·: https://neon.tech
# 2. åˆ›å»ºæ–°é¡¹ç›®: arabic-calligraphy-generator
# 3. è·å–è¿æ¥å­—ç¬¦ä¸²
# 4. æ·»åŠ åˆ°.env.local

DATABASE_URL="postgresql://user:password@host/database?sslmode=require"
```

#### 1.2 å®‰è£…ä¾èµ–

```bash
cd /Users/qiuweisen/CascadeProjects/arabic-calligraphy-creator

# å®‰è£…æ ¸å¿ƒä¾èµ–
npm install better-auth drizzle-orm @neondatabase/serverless stripe date-fns

# å®‰è£…å¼€å‘ä¾èµ–
npm install -D drizzle-kit
```

#### 1.3 é…ç½®Stripe

```bash
# 1. ç™»å½•Stripe Dashboard: https://dashboard.stripe.com
# 2. åˆ›å»ºäº§å“: Pro Subscription
# 3. åˆ›å»ºä»·æ ¼: $29.99/year
# 4. è·å–APIå¯†é’¥å’ŒPrice ID
# 5. é…ç½®Webhook endpoint: https://your-domain.com/api/payment/webhook
# 6. æ·»åŠ åˆ°.env.local

STRIPE_SECRET_KEY="sk_test_..."
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_..."
STRIPE_WEBHOOK_SECRET="whsec_..."
STRIPE_PRICE_ID_PRO_YEARLY="price_..."
```

### Phase 2: æ–‡ä»¶è¿ç§» (1-2å¤©)

#### 2.1 å¤åˆ¶æ ¸å¿ƒæ¨¡å—

âš ï¸ **é‡è¦**: ä½¿ç”¨æ­£ç¡®çš„ç›®å½•ç»“æ„,ä¿æŒä¸ç°æœ‰é¡¹ç›®ä¸€è‡´

```bash
# ä»mksaaså¤åˆ¶åˆ°å½“å‰é¡¹ç›®
cd /Users/qiuweisen/CascadeProjects/arabic-calligraphy-creator

# 1. å¤åˆ¶è®¤è¯æ¨¡å— (lib/auth*)
cp mksaas_template-cloudflare/src/lib/auth.ts lib/
cp mksaas_template-cloudflare/src/lib/auth-client.ts lib/

# 2. å¤åˆ¶URLå·¥å…· (authä¾èµ–)
mkdir -p lib/urls
cp mksaas_template-cloudflare/src/lib/urls/urls.ts lib/urls/

# 3. å¤åˆ¶æ”¯ä»˜æ¨¡å— (æ•´ä¸ªç›®å½•)
cp -r mksaas_template-cloudflare/src/payment ./

# 4. å¤åˆ¶ç§¯åˆ†æ¨¡å—(é¢„ç•™,æ•´ä¸ªç›®å½•)
cp -r mksaas_template-cloudflare/src/credits ./

# 5. å¤åˆ¶æ•°æ®åº“æ¨¡å—
cp -r mksaas_template-cloudflare/src/db ./

# 6. å¤åˆ¶é…ç½®æ–‡ä»¶
cp mksaas_template-cloudflare/src/config/website.tsx config/
cp mksaas_template-cloudflare/src/config/price-config.tsx config/
cp mksaas_template-cloudflare/src/config/credits-config.tsx config/ # å¯é€‰

# 7. å¤åˆ¶å·¥å…·å‡½æ•°
cp mksaas_template-cloudflare/src/lib/price-plan.ts lib/

# 8. å¤åˆ¶é‚®ä»¶æ¨¡å—(authçš„é‚®ç®±éªŒè¯éœ€è¦)
mkdir -p mail
cp -r mksaas_template-cloudflare/src/mail/* mail/
```

**å¤åˆ¶åçš„ç›®å½•ç»“æ„éªŒè¯**:
```bash
# éªŒè¯å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la lib/auth.ts lib/auth-client.ts
ls -la payment/index.ts payment/provider/stripe.ts
ls -la db/index.ts db/schema.ts
ls -la config/website.tsx config/price-config.tsx
```

#### 2.2 åˆ›å»ºé…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `config/subscription.ts`

```typescript
// å‰é¢å·²å®šä¹‰,å‚è€ƒ"è®¢é˜…è®¡åˆ’é…ç½®"éƒ¨åˆ†
```

**æ–‡ä»¶**: `drizzle.config.ts`

```typescript
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'postgresql',
  schema: './db/schema.ts',
  out: './db/migrations',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

#### 2.3 è°ƒæ•´å¯¼å…¥è·¯å¾„

âš ï¸ **å…³é”®æ­¥éª¤**: ç”±äºmksaasä½¿ç”¨ `src/` ç»“æ„,éœ€è¦æ‰¹é‡è°ƒæ•´å¯¼å…¥è·¯å¾„

```bash
# åœ¨æ‰€æœ‰å¤åˆ¶çš„æ–‡ä»¶ä¸­,å°†å¯¼å…¥è·¯å¾„è°ƒæ•´ä¸ºé¡¹ç›®çš„æ ¹ç›®å½•ç»“æ„
# ä¸éœ€è¦æ”¹tsconfig,å› ä¸º@/*å·²ç»æŒ‡å‘./

# ç¤ºä¾‹: lib/auth.ts ä¸­çš„å¯¼å…¥éœ€è¦ä»
# import { websiteConfig } from '@/config/website';
# ä¿æŒä¸å˜(å› ä¸º@/å·²ç»æŒ‡å‘æ ¹ç›®å½•)

# ä½†æ˜¯mksaasä¸­å¯èƒ½æœ‰ import from '@/src/...'
# éœ€è¦å»æ‰ /src éƒ¨åˆ†

# ä½¿ç”¨VS Codeå…¨å±€æœç´¢æ›¿æ¢:
# æœç´¢: from '@/src/
# æ›¿æ¢ä¸º: from '@/

# æˆ–è€…ä½¿ç”¨å‘½ä»¤è¡Œæ‰¹é‡æ›¿æ¢
find . -type f \( -name "*.ts" -o -name "*.tsx" \) \
  -not -path "./node_modules/*" \
  -not -path "./mksaas_template-cloudflare/*" \
  -exec sed -i '' 's/@\/src\//@\//g' {} +
```

**éªŒè¯å¯¼å…¥è·¯å¾„**:
```bash
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é”™è¯¯çš„å¯¼å…¥è·¯å¾„
grep -r "@/src/" --include="*.ts" --include="*.tsx" \
  --exclude-dir=node_modules \
  --exclude-dir=mksaas_template-cloudflare
# åº”è¯¥æ²¡æœ‰è¾“å‡º,å¦‚æœæœ‰åˆ™éœ€è¦æ‰‹åŠ¨ä¿®æ­£
```

### Phase 3: æ•°æ®åº“åˆå§‹åŒ– (0.5å¤©)

```bash
# 1. ç”Ÿæˆè¿ç§»æ–‡ä»¶
npx drizzle-kit generate

# 2. æŸ¥çœ‹ç”Ÿæˆçš„SQL
cat db/migrations/0000_*.sql

# 3. æ‰§è¡Œè¿ç§»
npx drizzle-kit migrate

# 4. éªŒè¯è¡¨ç»“æ„
npx drizzle-kit studio
# åœ¨æµè§ˆå™¨æ‰“å¼€ https://local.drizzle.studio
```

### Phase 4: è®¤è¯åŠŸèƒ½å®ç° (2å¤©)

#### 4.1 åˆ›å»ºAPIè·¯ç”±

**æ–‡ä»¶**: `app/api/auth/[...all]/route.ts`

```typescript
import { auth } from '@/lib/auth';
import { toNextJsHandler } from "better-auth/next-js";

export const { GET, POST } = toNextJsHandler(auth);
```

#### 4.2 åˆ›å»ºè®¤è¯é¡µé¢

**ç™»å½•é¡µ**: `app/(auth)/login/page.tsx`

```typescript
import { LoginForm } from '@/components/auth/login-form';
import { Suspense } from 'react';

export default function LoginPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-amber-50 to-white">
      <div className="w-full max-w-md px-4">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            ç™»å½•åˆ°é˜¿æ‹‰ä¼¯ä¹¦æ³•ç”Ÿæˆå™¨
          </h1>
          <p className="text-gray-600">
            ä½¿ç”¨ä½ çš„è´¦å·ç»§ç»­ä½¿ç”¨
          </p>
        </div>
        
        <Suspense fallback={<div>Loading...</div>}>
          <LoginForm />
        </Suspense>
        
        <p className="text-center mt-4 text-sm text-gray-600">
          è¿˜æ²¡æœ‰è´¦å·?{' '}
          <a href="/register" className="text-amber-600 hover:text-amber-700">
            ç«‹å³æ³¨å†Œ
          </a>
        </p>
      </div>
    </div>
  );
}
```

**æ³¨å†Œé¡µ**: `app/(auth)/register/page.tsx` (ç±»ä¼¼ç»“æ„)

#### 4.3 åˆ›å»ºè®¤è¯ç»„ä»¶

**æ–‡ä»¶**: `components/auth/login-form.tsx` (ä»mksaaså¤åˆ¶å¹¶è°ƒæ•´)

ä¸»è¦åŠŸèƒ½:
- Email + Passwordç™»å½•
- OAuthç™»å½•æŒ‰é’®
- é”™è¯¯å¤„ç†
- åŠ è½½çŠ¶æ€
- é‡å®šå‘å¤„ç†

#### å¯¼èˆªæ é›†æˆ

âš ï¸ **å…³é”®ä¿®æ­£**: ä½¿ç”¨next-intlçš„Linkå’ŒuseLocale,ä¸å†™æ­»è·¯å¾„

**æ–‡ä»¶**: `components/navbar.tsx` (ä¿®æ”¹ç°æœ‰æ–‡ä»¶)

```typescript
'use client';

import { authClient } from '@/lib/auth-client';
import { useSubscriptionStatus } from '@/hooks/use-subscription';
import Link from 'next/link';
import { useLocale } from 'next-intl';

export function Navbar() {
  const { data: session } = authClient.useSession();
  const { isPro } = useSubscriptionStatus();
  const locale = useLocale();

  return (
    <nav>
      {/* Logo */}
      <Link href={`/${locale}/`}>...</Link>
      
      {/* å¯¼èˆªé“¾æ¥ */}
      <Link href={`/${locale}/pricing`}>
        {t('nav.pricing')}
      </Link>
      
      {/* ç”¨æˆ·èœå• */}
      {session?.user ? (
        <DropdownMenu>
          <DropdownMenuTrigger>
            <Avatar>
              <AvatarImage src={session.user.image} />
              <AvatarFallback>{session.user.name?.[0]}</AvatarFallback>
            </Avatar>
          </DropdownMenuTrigger>
          <DropdownMenuContent>
            <DropdownMenuItem>
              <Link href={`/${locale}/dashboard`}>
                {t('nav.dashboard')}
              </Link>
            </DropdownMenuItem>
            {!isPro && (
              <DropdownMenuItem>
                <Link href={`/${locale}/pricing`} className="text-amber-600 font-semibold">
                  âš¡ {t('nav.upgradeToPro')}
                </Link>
              </DropdownMenuItem>
            )}
            <DropdownMenuItem onClick={() => authClient.signOut()}>
              {t('nav.signOut')}
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      ) : (
        <div className="flex gap-2">
          <Button variant="ghost" asChild>
            <Link href={`/${locale}/login`}>{t('nav.login')}</Link>
          </Button>
          <Button asChild>
            <Link href={`/${locale}/register`}>{t('nav.register')}</Link>
          </Button>
        </div>
      )}
    </nav>
  );
}
```

### 2. å®šä»·é¡µé¢ç»„ä»¶

âš ï¸ **PricingCardç»„ä»¶ç”¨æ³•ä¿®æ­£**: å‚è€ƒmksaaså®é™…props

**æ–‡ä»¶**: `app/[locale]/pricing/page.tsx` (æ–°å»º)

```typescript
import { getPricePlans } from '@/config/price-config';
import { PricingCard } from '@/components/payment/pricing-card';
import { PlanIntervals, PaymentTypes } from '@/payment/types';

export default function PricingPage() {
  // ä»é…ç½®è·å–è®¡åˆ’(å®¢æˆ·ç«¯ç»„ä»¶)
  const plans = getPricePlans();

  return (
    <div className="container mx-auto py-16">
      <h1 className="text-4xl font-bold text-center mb-12">
        Choose Your Plan
      </h1>
      
      <div className="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
        {/* Freeè®¡åˆ’ */}
        <PricingCard
          plan={plans.free}
          // Freeè®¡åˆ’ä¸éœ€è¦intervalå‚æ•°
        />
        
        {/* Proè®¡åˆ’ - âš ï¸ åªä¼ planå’Œinterval */}
        <PricingCard
          plan={plans.pro}
          interval={PlanIntervals.YEAR}
          // paymentTypeä¼šè‡ªåŠ¨è¯†åˆ«ä¸ºSUBSCRIPTION
        />
      </div>
    </div>
  );
}
```

**è¯´æ˜**:
- `PricingCard` ç»„ä»¶props: `plan: PricePlan`, `interval?: PlanInterval`, `paymentType?: PaymentType`, `metadata?: Record<string, string>`, `className?: string`, `isCurrentPlan?: boolean`
- ä¸è¦ä¼  `planId`/`priceId` ç­‰å•ç‹¬å‚æ•°,æ‰€æœ‰ä¿¡æ¯ä» `plan` å¯¹è±¡è·å–
- UIæ–‡æ¡ˆ(name/description/features)é€šè¿‡ `getPricePlans()` è‡ªåŠ¨æ³¨å…¥å¤šè¯­è¨€
- `interval` ç”¨äºåœ¨å¤šä¸ªä»·æ ¼é€‰é¡¹ä¸­é€‰æ‹©(å¦‚æœˆä»˜/å¹´ä»˜),Proå¹´ä»˜ä¼  `PlanIntervals.YEAR`

#### PNGä¸‹è½½ - æ·»åŠ æ°´å°

âš ï¸ **å…³é”®**: ä½¿ç”¨hookè·å–çš„è®¢é˜…çŠ¶æ€,ä¸åœ¨å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨æ•°æ®åº“å‡½æ•°

**æ–‡ä»¶**: `components/calligraphy-generator.tsx` (ä¿®æ”¹)

```typescript
const handleDownloadPNG = async () => {
  // âœ… ä»hookè·å–è®¢é˜…çŠ¶æ€(å·²ç»åœ¨ç»„ä»¶ä¸­å®šä¹‰)
  // const { isPro } = useSubscriptionStatus();
  
  // ç”Ÿæˆcanvas
  const canvas = await generatePreviewCanvas(previewRef.current, currentOptions, 4);
  
  // å¦‚æœä¸æ˜¯Proç”¨æˆ·,æ·»åŠ æ°´å°
  if (!isPro) {
    const ctx = canvas.getContext('2d');
    if (ctx) {
      // æ·»åŠ åŠé€æ˜æ°´å°
      ctx.globalAlpha = 0.3;
      ctx.font = '24px Arial';
      ctx.fillStyle = '#666666';
      ctx.textAlign = 'center';
      ctx.fillText('arabic-calligraphy-generator.com', canvas.width / 2, canvas.height - 30);
      ctx.globalAlpha = 1.0;
    }
  }
  
  // ä¸‹è½½
  const dataUrl = canvas.toDataURL('image/png', 1.0);
  // ...
};
```

---

## å®æ–½æ­¥éª¤

### Phase 1: ç¯å¢ƒå‡†å¤‡ (1å¤©)

#### 1.1 æ•°æ®åº“é…ç½®

```bash
# 1. æ³¨å†ŒNeonè´¦å·: https://neon.tech
# 2. åˆ›å»ºæ–°é¡¹ç›®: arabic-calligraphy-generator
# 3. è·å–è¿æ¥å­—ç¬¦ä¸²
# 4. æ·»åŠ åˆ°.env.local

DATABASE_URL="postgresql://user:password@host/database?sslmode=require"
```

#### 1.2 å®‰è£…ä¾èµ–

```bash
cd /Users/qiuweisen/CascadeProjects/arabic-calligraphy-creator

# å®‰è£…æ ¸å¿ƒä¾èµ–
npm install better-auth drizzle-orm @neondatabase/serverless stripe date-fns

# å®‰è£…å¼€å‘ä¾èµ–
npm install -D drizzle-kit
```

#### 1.3 é…ç½®Stripe

```bash
# 1. ç™»å½•Stripe Dashboard: https://dashboard.stripe.com
# 2. åˆ›å»ºäº§å“: Pro Subscription
# 3. åˆ›å»ºä»·æ ¼: $29.99/year
# 4. è·å–APIå¯†é’¥å’ŒPrice ID
# 5. é…ç½®Webhook endpoint: https://your-domain.com/api/payment/webhook
# 6. æ·»åŠ åˆ°.env.local

STRIPE_SECRET_KEY="sk_test_..."
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_..."
STRIPE_WEBHOOK_SECRET="whsec_..."
STRIPE_PRICE_ID_PRO_YEARLY="price_..."
```

### Phase 2: æ–‡ä»¶è¿ç§» (1-2å¤©)

#### 2.1 å¤åˆ¶æ ¸å¿ƒæ¨¡å—

âš ï¸ **é‡è¦**: ä½¿ç”¨æ­£ç¡®çš„ç›®å½•ç»“æ„,ä¿æŒä¸ç°æœ‰é¡¹ç›®ä¸€è‡´

```bash
# ä»mksaaså¤åˆ¶åˆ°å½“å‰é¡¹ç›®
cd /Users/qiuweisen/CascadeProjects/arabic-calligraphy-creator

# 1. å¤åˆ¶è®¤è¯æ¨¡å— (lib/auth*)
cp mksaas_template-cloudflare/src/lib/auth.ts lib/
cp mksaas_template-cloudflare/src/lib/auth-client.ts lib/

# 2. å¤åˆ¶URLå·¥å…· (authä¾èµ–)
mkdir -p lib/urls
cp mksaas_template-cloudflare/src/lib/urls/urls.ts lib/urls/

# 3. å¤åˆ¶æ”¯ä»˜æ¨¡å— (æ•´ä¸ªç›®å½•)
cp -r mksaas_template-cloudflare/src/payment ./

# 4. å¤åˆ¶ç§¯åˆ†æ¨¡å—(é¢„ç•™,æ•´ä¸ªç›®å½•)
cp -r mksaas_template-cloudflare/src/credits ./

# 5. å¤åˆ¶æ•°æ®åº“æ¨¡å—
cp -r mksaas_template-cloudflare/src/db ./

# 6. å¤åˆ¶é…ç½®æ–‡ä»¶
cp mksaas_template-cloudflare/src/config/website.tsx config/
cp mksaas_template-cloudflare/src/config/price-config.tsx config/
cp mksaas_template-cloudflare/src/config/credits-config.tsx config/ # å¯é€‰

# 7. å¤åˆ¶å·¥å…·å‡½æ•°
cp mksaas_template-cloudflare/src/lib/price-plan.ts lib/

# 8. å¤åˆ¶é‚®ä»¶æ¨¡å—(authçš„é‚®ç®±éªŒè¯éœ€è¦)
mkdir -p mail
cp -r mksaas_template-cloudflare/src/mail/* mail/
```

**å¤åˆ¶åçš„ç›®å½•ç»“æ„éªŒè¯**:
```bash
# éªŒè¯å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la lib/auth.ts lib/auth-client.ts
ls -la payment/index.ts payment/provider/stripe.ts
ls -la db/index.ts db/schema.ts
ls -la config/website.tsx config/price-config.tsx
```

#### 2.2 åˆ›å»ºé…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `config/subscription.ts`

```typescript
// å‰é¢å·²å®šä¹‰,å‚è€ƒ"è®¢é˜…è®¡åˆ’é…ç½®"éƒ¨åˆ†
```

**æ–‡ä»¶**: `drizzle.config.ts`

```typescript
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'postgresql',
  schema: './db/schema.ts',
  out: './db/migrations',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

#### 2.3 è°ƒæ•´å¯¼å…¥è·¯å¾„

âš ï¸ **å…³é”®æ­¥éª¤**: ç”±äºmksaasä½¿ç”¨ `src/` ç»“æ„,éœ€è¦æ‰¹é‡è°ƒæ•´å¯¼å…¥è·¯å¾„

```bash
# åœ¨æ‰€æœ‰å¤åˆ¶çš„æ–‡ä»¶ä¸­,å°†å¯¼å…¥è·¯å¾„è°ƒæ•´ä¸ºé¡¹ç›®çš„æ ¹ç›®å½•ç»“æ„
# ä¸éœ€è¦æ”¹tsconfig,å› ä¸º@/*å·²ç»æŒ‡å‘./

# ç¤ºä¾‹: lib/auth.ts ä¸­çš„å¯¼å…¥éœ€è¦ä»
# import { websiteConfig } from '@/config/website';
# ä¿æŒä¸å˜(å› ä¸º@/å·²ç»æŒ‡å‘æ ¹ç›®å½•)

# ä½†æ˜¯mksaasä¸­å¯èƒ½æœ‰ import from '@/src/...'
# éœ€è¦å»æ‰ /src éƒ¨åˆ†

# ä½¿ç”¨VS Codeå…¨å±€æœç´¢æ›¿æ¢:
# æœç´¢: from '@/src/
# æ›¿æ¢ä¸º: from '@/

# æˆ–è€…ä½¿ç”¨å‘½ä»¤è¡Œæ‰¹é‡æ›¿æ¢
find . -type f \( -name "*.ts" -o -name "*.tsx" \) \
  -not -path "./node_modules/*" \
  -not -path "./mksaas_template-cloudflare/*" \
  -exec sed -i '' 's/@\/src\//@\//g' {} +
```

**éªŒè¯å¯¼å…¥è·¯å¾„**:
```bash
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é”™è¯¯çš„å¯¼å…¥è·¯å¾„
grep -r "@/src/" --include="*.ts" --include="*.tsx" \
  --exclude-dir=node_modules \
  --exclude-dir=mksaas_template-cloudflare
# åº”è¯¥æ²¡æœ‰è¾“å‡º,å¦‚æœæœ‰åˆ™éœ€è¦æ‰‹åŠ¨ä¿®æ­£
```

### Phase 3: æ•°æ®åº“åˆå§‹åŒ– (0.5å¤©)

```bash
# 1. ç”Ÿæˆè¿ç§»æ–‡ä»¶
npx drizzle-kit generate

# 2. æŸ¥çœ‹ç”Ÿæˆçš„SQL
cat db/migrations/0000_*.sql

# 3. æ‰§è¡Œè¿ç§»
npx drizzle-kit migrate

# 4. éªŒè¯è¡¨ç»“æ„
npx drizzle-kit studio
# åœ¨æµè§ˆå™¨æ‰“å¼€ https://local.drizzle.studio
```

### Phase 4: è®¤è¯åŠŸèƒ½å®ç° (2å¤©)

#### 4.1 åˆ›å»ºAPIè·¯ç”±

**æ–‡ä»¶**: `app/api/auth/[...all]/route.ts`

```typescript
import { auth } from '@/lib/auth';
import { toNextJsHandler } from "better-auth/next-js";

export const { GET, POST } = toNextJsHandler(auth);
```

#### 4.2 åˆ›å»ºè®¤è¯é¡µé¢

**ç™»å½•é¡µ**: `app/(auth)/login/page.tsx`

```typescript
import { LoginForm } from '@/components/auth/login-form';
import { Suspense } from 'react';

export default function LoginPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-amber-50 to-white">
      <div className="w-full max-w-md px-4">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            ç™»å½•åˆ°é˜¿æ‹‰ä¼¯ä¹¦æ³•ç”Ÿæˆå™¨
          </h1>
          <p className="text-gray-600">
            ä½¿ç”¨ä½ çš„è´¦å·ç»§ç»­ä½¿ç”¨
          </p>
        </div>
        
        <Suspense fallback={<div>Loading...</div>}>
          <LoginForm />
        </Suspense>
        
        <p className="text-center mt-4 text-sm text-gray-600">
          è¿˜æ²¡æœ‰è´¦å·?{' '}
          <a href="/register" className="text-amber-600 hover:text-amber-700">
            ç«‹å³æ³¨å†Œ
          </a>
        </p>
      </div>
    </div>
  );
}
```

**æ³¨å†Œé¡µ**: `app/(auth)/register/page.tsx` (ç±»ä¼¼ç»“æ„)

#### 4.3 åˆ›å»ºè®¤è¯ç»„ä»¶

**æ–‡ä»¶**: `components/auth/login-form.tsx` (ä»mksaaså¤åˆ¶å¹¶è°ƒæ•´)

ä¸»è¦åŠŸèƒ½:
- Email + Passwordç™»å½•
- OAuthç™»å½•æŒ‰é’®
- é”™è¯¯å¤„ç†
- åŠ è½½çŠ¶æ€
- é‡å®šå‘å¤„ç†

#### å¯¼èˆªæ é›†æˆ

âš ï¸ **å…³é”®ä¿®æ­£**: ä½¿ç”¨next-intlçš„Linkå’ŒuseLocale,ä¸å†™æ­»è·¯å¾„

**æ–‡ä»¶**: `components/navbar.tsx` (ä¿®æ”¹ç°æœ‰æ–‡ä»¶)

```typescript
'use client';

import { authClient } from '@/lib/auth-client';
import { useSubscriptionStatus } from '@/hooks/use-subscription';
import Link from 'next/link';
import { useLocale } from 'next-intl';

export function Navbar() {
  const { data: session } = authClient.useSession();
  const { isPro } = useSubscriptionStatus();
  const locale = useLocale();

  return (
    <nav>
      {/* Logo */}
      <Link href={`/${locale}/`}>...</Link>
      
      {/* å¯¼èˆªé“¾æ¥ */}
      <Link href={`/${locale}/pricing`}>
        {t('nav.pricing')}
      </Link>
      
      {/* ç”¨æˆ·èœå• */}
      {session?.user ? (
        <DropdownMenu>
          <DropdownMenuTrigger>
            <Avatar>
              <AvatarImage src={session.user.image} />
              <AvatarFallback>{session.user.name?.[0]}</AvatarFallback>
            </Avatar>
          </DropdownMenuTrigger>
          <DropdownMenuContent>
            <DropdownMenuItem>
              <Link href={`/${locale}/dashboard`}>
                {t('nav.dashboard')}
              </Link>
            </DropdownMenuItem>
            {!isPro && (
              <DropdownMenuItem>
                <Link href={`/${locale}/pricing`} className="text-amber-600 font-semibold">
                  âš¡ {t('nav.upgradeToPro')}
                </Link>
              </DropdownMenuItem>
            )}
            <DropdownMenuItem onClick={() => authClient.signOut()}>
              {t('nav.signOut')}
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      ) : (
        <div className="flex gap-2">
          <Button variant="ghost" asChild>
            <Link href={`/${locale}/login`}>{t('nav.login')}</Link>
          </Button>
          <Button asChild>
            <Link href={`/${locale}/register`}>{t('nav.register')}</Link>
          </Button>
        </div>
      )}
    </nav>
  );
}
```

### 2. å®šä»·é¡µé¢ç»„ä»¶

âš ï¸ **PricingCardç»„ä»¶ç”¨æ³•ä¿®æ­£**: å‚è€ƒmksaaså®é™…props

**æ–‡ä»¶**: `app/[locale]/pricing/page.tsx` (æ–°å»º)

```typescript
import { getPricePlans } from '@/config/price-config';
import { PricingCard } from '@/components/payment/pricing-card';
import { PlanIntervals, PaymentTypes } from '@/payment/types';

export default function PricingPage() {
  // ä»é…ç½®è·å–è®¡åˆ’(å®¢æˆ·ç«¯ç»„ä»¶)
  const plans = getPricePlans();

  return (
    <div className="container mx-auto py-16">
      <h1 className="text-4xl font-bold text-center mb-12">
        Choose Your Plan
      </h1>
      
      <div className="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
        {/* Freeè®¡åˆ’ */}
        <PricingCard
          plan={plans.free}
          // Freeè®¡åˆ’ä¸éœ€è¦intervalå‚æ•°
        />
        
        {/* Proè®¡åˆ’ - âš ï¸ åªä¼ planå’Œinterval */}
        <PricingCard
          plan={plans.pro}
          interval={PlanIntervals.YEAR}
          // paymentTypeä¼šè‡ªåŠ¨è¯†åˆ«ä¸ºSUBSCRIPTION
        />
      </div>
    </div>
  );
}
```

**è¯´æ˜**:
- `PricingCard` ç»„ä»¶props: `plan: PricePlan`, `interval?: PlanInterval`, `paymentType?: PaymentType`, `metadata?: Record<string, string>`, `className?: string`, `isCurrentPlan?: boolean`
- ä¸è¦ä¼  `planId`/`priceId` ç­‰å•ç‹¬å‚æ•°,æ‰€æœ‰ä¿¡æ¯ä» `plan` å¯¹è±¡è·å–
- UIæ–‡æ¡ˆ(name/description/features)é€šè¿‡ `getPricePlans()` è‡ªåŠ¨æ³¨å…¥å¤šè¯­è¨€
- `interval` ç”¨äºåœ¨å¤šä¸ªä»·æ ¼é€‰é¡¹ä¸­é€‰æ‹©(å¦‚æœˆä»˜/å¹´ä»˜),Proå¹´ä»˜ä¼  `PlanIntervals.YEAR`

#### PNGä¸‹è½½ - æ·»åŠ æ°´å°

âš ï¸ **å…³é”®**: ä½¿ç”¨hookè·å–çš„è®¢é˜…çŠ¶æ€,ä¸åœ¨å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨æ•°æ®åº“å‡½æ•°

**æ–‡ä»¶**: `components/calligraphy-generator.tsx` (ä¿®æ”¹)

```typescript
const handleDownloadPNG = async () => {
  // âœ… ä»hookè·å–è®¢é˜…çŠ¶æ€(å·²ç»åœ¨ç»„ä»¶ä¸­å®šä¹‰)
  // const { isPro } = useSubscriptionStatus();
  
  // ç”Ÿæˆcanvas
  const canvas = await generatePreviewCanvas(previewRef.current, currentOptions, 4);
  
  // å¦‚æœä¸æ˜¯Proç”¨æˆ·,æ·»åŠ æ°´å°
  if (!isPro) {
    const ctx = canvas.getContext('2d');
    if (ctx) {
      // æ·»åŠ åŠé€æ˜æ°´å°
      ctx.globalAlpha = 0.3;
      ctx.font = '24px Arial';
      ctx.fillStyle = '#666666';
      ctx.textAlign = 'center';
      ctx.fillText('arabic-calligraphy-generator.com', canvas.width / 2, canvas.height - 30);
      ctx.globalAlpha = 1.0;
    }
  }
  
  // ä¸‹è½½
  const dataUrl = canvas.toDataURL('image/png', 1.0);
  // ...
};
```

---

## å®æ–½æ­¥éª¤

### Phase 1: ç¯å¢ƒå‡†å¤‡ (1å¤©)

#### 1.1 æ•°æ®åº“é…ç½®

```bash
# 1. æ³¨å†ŒNeonè´¦å·: https://neon.tech
# 2. åˆ›å»ºæ–°é¡¹ç›®: arabic-calligraphy-generator
# 3. è·å–è¿æ¥å­—ç¬¦ä¸²
# 4. æ·»åŠ åˆ°.env.local

DATABASE_URL="postgresql://user:password@host/database?sslmode=require"
```

#### 1.2 å®‰è£…ä¾èµ–

```bash
cd /Users/qiuweisen/CascadeProjects/arabic-calligraphy-creator

# å®‰è£…æ ¸å¿ƒä¾èµ–
npm install better-auth drizzle-orm @neondatabase/serverless stripe date-fns

# å®‰è£…å¼€å‘ä¾èµ–
npm install -D drizzle-kit
```

#### 1.3 é…ç½®Stripe

```bash
# 1. ç™»å½•Stripe Dashboard: https://dashboard.stripe.com
# 2. åˆ›å»ºäº§å“: Pro Subscription
# 3. åˆ›å»ºä»·æ ¼: $29.99/year
# 4. è·å–APIå¯†é’¥å’ŒPrice ID
# 5. é…ç½®Webhook endpoint: https://your-domain.com/api/payment/webhook
# 6. æ·»åŠ åˆ°.env.local

STRIPE_SECRET_KEY="sk_test_..."
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_..."
STRIPE_WEBHOOK_SECRET="whsec_..."
STRIPE_PRICE_ID_PRO_YEARLY="price_..."
```

### Phase 2: æ–‡ä»¶è¿ç§» (1-2å¤©)

#### 2.1 å¤åˆ¶æ ¸å¿ƒæ¨¡å—

âš ï¸ **é‡è¦**: ä½¿ç”¨æ­£ç¡®çš„ç›®å½•ç»“æ„,ä¿æŒä¸ç°æœ‰é¡¹ç›®ä¸€è‡´

```bash
# ä»mksaaså¤åˆ¶åˆ°å½“å‰é¡¹ç›®
cd /Users/qiuweisen/CascadeProjects/arabic-calligraphy-creator

# 1. å¤åˆ¶è®¤è¯æ¨¡å— (lib/auth*)
cp mksaas_template-cloudflare/src/lib/auth.ts lib/
cp mksaas_template-cloudflare/src/lib/auth-client.ts lib/

# 2. å¤åˆ¶URLå·¥å…· (authä¾èµ–)
mkdir -p lib/urls
cp mksaas_template-cloudflare/src/lib/urls/urls.ts lib/urls/

# 3. å¤åˆ¶æ”¯ä»˜æ¨¡å— (æ•´ä¸ªç›®å½•)
cp -r mksaas_template-cloudflare/src/payment ./

# 4. å¤åˆ¶ç§¯åˆ†æ¨¡å—(é¢„ç•™,æ•´ä¸ªç›®å½•)
cp -r mksaas_template-cloudflare/src/credits ./

# 5. å¤åˆ¶æ•°æ®åº“æ¨¡å—
cp -r mksaas_template-cloudflare/src/db ./

# 6. å¤åˆ¶é…ç½®æ–‡ä»¶
cp mksaas_template-cloudflare/src/config/website.tsx config/
cp mksaas_template-cloudflare/src/config/price-config.tsx config/
cp mksaas_template-cloudflare/src/config/credits-config.tsx config/ # å¯é€‰

# 7. å¤åˆ¶å·¥å…·å‡½æ•°
cp mksaas_template-cloudflare/src/lib/price-plan.ts lib/

# 8. å¤åˆ¶é‚®ä»¶æ¨¡å—(authçš„é‚®ç®±éªŒè¯éœ€è¦)
mkdir -p mail
cp -r mksaas_template-cloudflare/src/mail/* mail/
```

**å¤åˆ¶åçš„ç›®å½•ç»“æ„éªŒè¯**:
```bash
# éªŒè¯å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la lib/auth.ts lib/auth-client.ts
ls -la payment/index.ts payment/provider/stripe.ts
ls -la db/index.ts db/schema.ts
ls -la config/website.tsx config/price-config.tsx
```

#### 2.2 åˆ›å»ºé…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `config/subscription.ts`

```typescript
// å‰é¢å·²å®šä¹‰,å‚è€ƒ"è®¢é˜…è®¡åˆ’é…ç½®"éƒ¨åˆ†
```

**æ–‡ä»¶**: `drizzle.config.ts`

```typescript
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'postgresql',
  schema: './db/schema.ts',
  out: './db/migrations',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

#### 2.3 è°ƒæ•´å¯¼å…¥è·¯å¾„

âš ï¸ **å…³é”®æ­¥éª¤**: ç”±äºmksaasä½¿ç”¨ `src/` ç»“æ„,éœ€è¦æ‰¹é‡è°ƒæ•´å¯¼å…¥è·¯å¾„

```bash
# åœ¨æ‰€æœ‰å¤åˆ¶çš„æ–‡ä»¶ä¸­,å°†å¯¼å…¥è·¯å¾„è°ƒæ•´ä¸ºé¡¹ç›®çš„æ ¹ç›®å½•ç»“æ„
# ä¸éœ€è¦æ”¹tsconfig,å› ä¸º@/*å·²ç»æŒ‡å‘./

# ç¤ºä¾‹: lib/auth.ts ä¸­çš„å¯¼å…¥éœ€è¦ä»
# import { websiteConfig } from '@/config/website';
# ä¿æŒä¸å˜(å› ä¸º@/å·²ç»æŒ‡å‘æ ¹ç›®å½•)

# ä½†æ˜¯mksaasä¸­å¯èƒ½æœ‰ import from '@/src/...'
# éœ€è¦å»æ‰ /src éƒ¨åˆ†

# ä½¿ç”¨VS Codeå…¨å±€æœç´¢æ›¿æ¢:
# æœç´¢: from '@/src/
# æ›¿æ¢ä¸º: from '@/

# æˆ–è€…ä½¿ç”¨å‘½ä»¤è¡Œæ‰¹é‡æ›¿æ¢
find . -type f \( -name "*.ts" -o -name "*.tsx" \) \
  -not -path "./node_modules/*" \
  -not -path "./mksaas_template-cloudflare/*" \
  -exec sed -i '' 's/@\/src\//@\//g' {} +
```

**éªŒè¯å¯¼å…¥è·¯å¾„**:
```bash
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é”™è¯¯çš„å¯¼å…¥è·¯å¾„
grep -r "@/src/" --include="*.ts" --include="*.tsx" \
  --exclude-dir=node_modules \
  --exclude-dir=mksaas_template-cloudflare
# åº”è¯¥æ²¡æœ‰è¾“å‡º,å¦‚æœæœ‰åˆ™éœ€è¦æ‰‹åŠ¨ä¿®æ­£
```

### Phase 3: æ•°æ®åº“åˆå§‹åŒ– (0.5å¤©)

```bash
# 1. ç”Ÿæˆè¿ç§»æ–‡ä»¶
npx drizzle-kit generate

# 2. æŸ¥çœ‹ç”Ÿæˆçš„SQL
cat db/migrations/0000_*.sql

# 3. æ‰§è¡Œè¿ç§»
npx drizzle-kit migrate

# 4. éªŒè¯è¡¨ç»“æ„
npx drizzle-kit studio
# åœ¨æµè§ˆå™¨æ‰“å¼€ https://local.drizzle.studio
```

### Phase 4: è®¤è¯åŠŸèƒ½å®ç° (2å¤©)

#### 4.1 åˆ›å»ºAPIè·¯ç”±

**æ–‡ä»¶**: `app/api/auth/[...all]/route.ts`

```typescript
import { auth } from '@/lib/auth';
import { toNextJsHandler } from "better-auth/next-js";

export const { GET, POST } = toNextJsHandler(auth);
```

#### 4.2 åˆ›å»ºè®¤è¯é¡µé¢

**ç™»å½•é¡µ**: `app/(auth)/login/page.tsx`

```typescript
import { LoginForm } from '@/components/auth/login-form';
import { Suspense } from 'react';

export default function LoginPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-amber-50 to-white">
      <div className="w-full max-w-md px-4">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            ç™»å½•åˆ°é˜¿æ‹‰ä¼¯ä¹¦æ³•ç”Ÿæˆå™¨
          </h1>
          <p className="text-gray-600">
            ä½¿ç”¨ä½ çš„è´¦å·ç»§ç»­ä½¿ç”¨
          </p>
        </div>
        
        <Suspense fallback={<div>Loading...</div>}>
          <LoginForm />
        </Suspense>
        
        <p className="text-center mt-4 text-sm text-gray-600">
          è¿˜æ²¡æœ‰è´¦å·?{' '}
          <a href="/register" className="text-amber-600 hover:text-amber-700">
            ç«‹å³æ³¨å†Œ
          </a>
        </p>
      </div>
    </div>
  );
}
```

**æ³¨å†Œé¡µ**: `app/(auth)/register/page.tsx` (ç±»ä¼¼ç»“æ„)

#### 4.3 åˆ›å»ºè®¤è¯ç»„ä»¶

**æ–‡ä»¶**: `components/auth/login-form.tsx` (ä»mksaaså¤åˆ¶å¹¶è°ƒæ•´)

ä¸»è¦åŠŸèƒ½:
- Email + Passwordç™»å½•
- OAuthç™»å½•æŒ‰é’®
- é”™è¯¯å¤„ç†
- åŠ è½½çŠ¶æ€
- é‡å®šå‘å¤„ç†

#### å¯¼èˆªæ é›†æˆ

âš ï¸ **å…³é”®ä¿®æ­£**: ä½¿ç”¨next-intlçš„Linkå’ŒuseLocale,ä¸å†™æ­»è·¯å¾„

**æ–‡ä»¶**: `components/navbar.tsx` (ä¿®æ”¹ç°æœ‰æ–‡ä»¶)

```typescript
'use client';

import { authClient } from '@/lib/auth-client';
import { useSubscriptionStatus } from '@/hooks/use-subscription';
import Link from 'next/link';
import { useLocale } from 'next-intl';

export function Navbar() {
  const { data: session } = authClient.useSession();
  const { isPro } = useSubscriptionStatus();
  const locale = useLocale();

  return (
    <nav>
      {/* Logo */}
      <Link href={`/${locale}/`}>...</Link>
      
      {/* å¯¼èˆªé“¾æ¥ */}
      <Link href={`/${locale}/pricing`}>
        {t('nav.pricing')}
      </Link>
      
      {/* ç”¨æˆ·èœå• */}
      {session?.user ? (
        <DropdownMenu>
          <DropdownMenuTrigger>
            <Avatar>
              <AvatarImage src={session.user.image} />
              <AvatarFallback>{session.user.name?.[0]}</AvatarFallback>
            </Avatar>
          </DropdownMenuTrigger>
          <DropdownMenuContent>
            <DropdownMenuItem>
              <Link href={`/${locale}/dashboard`}>
                {t('nav.dashboard')}
              </Link>
            </DropdownMenuItem>
            {!isPro && (
              <DropdownMenuItem>
                <Link href={`/${locale}/pricing`} className="text-amber-600 font-semibold">
                  âš¡ {t('nav.upgradeToPro')}
                </Link>
              </DropdownMenuItem>
            )}
            <DropdownMenuItem onClick={() => authClient.signOut()}>
              {t('nav.signOut')}
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      ) : (
        <div className="flex gap-2">
          <Button variant="ghost" asChild>
            <Link href={`/${locale}/login`}>{t('nav.login')}</Link>
          </Button>
          <Button asChild>
            <Link href={`/${locale}/register`}>{t('nav.register')}</Link>
          </Button>
        </div>
      )}
    </nav>
  );
}
```

### 2. å®šä»·é¡µé¢ç»„ä»¶

âš ï¸ **PricingCardç»„ä»¶ç”¨æ³•ä¿®æ­£**: å‚è€ƒmksaaså®é™…props

**æ–‡ä»¶**: `app/[locale]/pricing/page.tsx` (æ–°å»º)

```typescript
import { getPricePlans } from '@/config/price-config';
import { PricingCard } from '@/components/payment/pricing-card';
import { PlanIntervals, PaymentTypes } from '@/payment/types';

export default function PricingPage() {
  // ä»é…ç½®è·å–è®¡åˆ’(å®¢æˆ·ç«¯ç»„ä»¶)
  const plans = getPricePlans();

  return (
    <div className="container mx-auto py-16">
      <h1 className="text-4xl font-bold text-center mb-12">
        Choose Your Plan
      </h1>
      
      <div className="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
        {/* Freeè®¡åˆ’ */}
        <PricingCard
          plan={plans.free}
          // Freeè®¡åˆ’ä¸éœ€è¦intervalå‚æ•°
        />
        
        {/* Proè®¡åˆ’ - âš ï¸ åªä¼ planå’Œinterval */}
        <PricingCard
          plan={plans.pro}
          interval={PlanIntervals.YEAR}
          // paymentTypeä¼šè‡ªåŠ¨è¯†åˆ«ä¸ºSUBSCRIPTION
        />
      </div>
    </div>
  );
}
```

**è¯´æ˜**:
- `PricingCard` ç»„ä»¶props: `plan: PricePlan`, `interval?: PlanInterval`, `paymentType?: PaymentType`, `metadata?: Record<string, string>`, `className?: string`, `isCurrentPlan?: boolean`
- ä¸è¦ä¼  `planId`/`priceId` ç­‰å•ç‹¬å‚æ•°,æ‰€æœ‰ä¿¡æ¯ä» `plan` å¯¹è±¡è·å–
- UIæ–‡æ¡ˆ(name/description/features)é€šè¿‡ `getPricePlans()` è‡ªåŠ¨æ³¨å…¥å¤šè¯­è¨€
- `interval` ç”¨äºåœ¨å¤šä¸ªä»·æ ¼é€‰é¡¹ä¸­é€‰æ‹©(å¦‚æœˆä»˜/å¹´ä»˜),Proå¹´ä»˜ä¼  `PlanIntervals.YEAR`

#### PNGä¸‹è½½ - æ·»åŠ æ°´å°

âš ï¸ **å…³é”®**: ä½¿ç”¨hookè·å–çš„è®¢é˜…çŠ¶æ€,ä¸åœ¨å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨æ•°æ®åº“å‡½æ•°

**æ–‡ä»¶**: `components/calligraphy-generator.tsx` (ä¿®æ”¹)

```typescript
const handleDownloadPNG = async () => {
  // âœ… ä»hookè·å–è®¢é˜…çŠ¶æ€(å·²ç»åœ¨ç»„ä»¶ä¸­å®šä¹‰)
  // const { isPro } = useSubscriptionStatus();
  
  // ç”Ÿæˆcanvas
  const canvas = await generatePreviewCanvas(previewRef.current, currentOptions, 4);
  
  // å¦‚æœä¸æ˜¯Proç”¨æˆ·,æ·»åŠ æ°´å°
  if (!isPro) {
    const ctx = canvas.getContext('2d');
    if (ctx) {
      // æ·»åŠ åŠé€æ˜æ°´å°
      ctx.globalAlpha = 0.3;
      ctx.font = '24px Arial';
      ctx.fillStyle = '#666666';
      ctx.textAlign = 'center';
      ctx.fillText('arabic-calligraphy-generator.com', canvas.width / 2, canvas.height - 30);
      ctx.globalAlpha = 1.0;
    }
  }
  
  // ä¸‹è½½
  const dataUrl = canvas.toDataURL('image/png', 1.0);
  // ...
};
```

---

## å®æ–½æ­¥éª¤

### Phase 1: ç¯å¢ƒå‡†å¤‡ (1å¤©)

#### 1.1 æ•°æ®åº“é…ç½®

```bash
# 1. æ³¨å†ŒNeonè´¦å·: https://neon.tech
# 2. åˆ›å»ºæ–°é¡¹ç›®: arabic-calligraphy-generator
# 3. è·å–è¿æ¥å­—ç¬¦ä¸²
# 4. æ·»åŠ åˆ°.env.local

DATABASE_URL="postgresql://user:password@host/database?sslmode=require"
```

#### 1.2 å®‰è£…ä¾èµ–

```bash
cd /Users/qiuweisen/CascadeProjects/arabic-calligraphy-creator

# å®‰è£…æ ¸å¿ƒä¾èµ–
npm install better-auth drizzle-orm @neondatabase/serverless stripe date-fns

# å®‰è£…å¼€å‘ä¾èµ–
npm install -D drizzle-kit
```

#### 1.3 é…ç½®Stripe

```bash
# 1. ç™»å½•Stripe Dashboard: https://dashboard.stripe.com
# 2. åˆ›å»ºäº§å“: Pro Subscription
# 3. åˆ›å»ºä»·æ ¼: $29.99/year
# 4. è·å–APIå¯†é’¥å’ŒPrice ID
# 5. é…ç½®Webhook endpoint: https://your-domain.com/api/payment/webhook
# 6. æ·»åŠ åˆ°.env.local

STRIPE_SECRET_KEY="sk_test_..."
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_..."
STRIPE_WEBHOOK_SECRET="whsec_..."
STRIPE_PRICE_ID_PRO_YEARLY="price_..."
```

### Phase 2: æ–‡ä»¶è¿ç§» (1-2å¤©)

#### 2.1 å¤åˆ¶æ ¸å¿ƒæ¨¡å—

âš ï¸ **é‡è¦**: ä½¿ç”¨æ­£ç¡®çš„ç›®å½•ç»“æ„,ä¿æŒä¸ç°æœ‰é¡¹ç›®ä¸€è‡´

```bash
# ä»mksaaså¤åˆ¶åˆ°å½“å‰é¡¹ç›®
cd /Users/qiuweisen/CascadeProjects/arabic-calligraphy-creator

# 1. å¤åˆ¶è®¤è¯æ¨¡å— (lib/auth*)
cp mksaas_template-cloudflare/src/lib/auth.ts lib/
cp mksaas_template-cloudflare/src/lib/auth-client.ts lib/

# 2. å¤åˆ¶URLå·¥å…· (authä¾èµ–)
mkdir -p lib/urls
cp mksaas_template-cloudflare/src/lib/urls/urls.ts lib/urls/

# 3. å¤åˆ¶æ”¯ä»˜æ¨¡å— (æ•´ä¸ªç›®å½•)
cp -r mksaas_template-cloudflare/src/payment ./

# 4. å¤åˆ¶ç§¯åˆ†æ¨¡å—(é¢„ç•™,æ•´ä¸ªç›®å½•)
cp -r mksaas_template-cloudflare/src/credits ./

# 5. å¤åˆ¶æ•°æ®åº“æ¨¡å—
cp -r mksaas_template-cloudflare/src/db ./

# 6. å¤åˆ¶é…ç½®æ–‡ä»¶
cp mksaas_template-cloudflare/src/config/website.tsx config/
cp mksaas_template-cloudflare/src/config/price-config.tsx config/
cp mksaas_template-cloudflare/src/config/credits-config.tsx config/ # å¯é€‰

# 7. å¤åˆ¶å·¥å…·å‡½æ•°
cp mksaas_template-cloudflare/src/lib/price-plan.ts lib/

# 8. å¤åˆ¶é‚®ä»¶æ¨¡å—(authçš„é‚®ç®±éªŒè¯éœ€è¦)
mkdir -p mail
cp -r mksaas_template-cloudflare/src/mail/* mail/
```

**å¤åˆ¶åçš„ç›®å½•ç»“æ„éªŒè¯**:
```bash
# éªŒè¯å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la lib/auth.ts lib/auth-client.ts
ls -la payment/index.ts payment/provider/stripe.ts
ls -la db/index.ts db/schema.ts
ls -la config/website.tsx config/price-config.tsx
```

#### 2.2 åˆ›å»ºé…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `config/subscription.ts`

```typescript
// å‰é¢å·²å®šä¹‰,å‚è€ƒ"è®¢é˜…è®¡åˆ’é…ç½®"éƒ¨åˆ†
```

**æ–‡ä»¶**: `drizzle.config.ts`

```typescript
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'postgresql',
  schema: './db/schema.ts',
  out: './db/migrations',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

#### 2.3 è°ƒæ•´å¯¼å…¥è·¯å¾„

âš ï¸ **å…³é”®æ­¥éª¤**: ç”±äºmksaasä½¿ç”¨ `src/` ç»“æ„,éœ€è¦æ‰¹é‡è°ƒæ•´å¯¼å…¥è·¯å¾„

```bash
# åœ¨æ‰€æœ‰å¤åˆ¶çš„æ–‡ä»¶ä¸­,å°†å¯¼å…¥è·¯å¾„è°ƒæ•´ä¸ºé¡¹ç›®çš„æ ¹ç›®å½•ç»“æ„
# ä¸éœ€è¦æ”¹tsconfig,å› ä¸º@/*å·²ç»æŒ‡å‘./

# ç¤ºä¾‹: lib/auth.ts ä¸­çš„å¯¼å…¥éœ€è¦ä»
# import { websiteConfig } from '@/config/website';
# ä¿æŒä¸å˜(å› ä¸º@/å·²ç»æŒ‡å‘æ ¹ç›®å½•)

# ä½†æ˜¯mksaasä¸­å¯èƒ½æœ‰ import from '@/src/...'
# éœ€è¦å»æ‰ /src éƒ¨åˆ†

# ä½¿ç”¨VS Codeå…¨å±€æœç´¢æ›¿æ¢:
# æœç´¢: from '@/src/
# æ›¿æ¢ä¸º: from '@/

# æˆ–è€…ä½¿ç”¨å‘½ä»¤è¡Œæ‰¹é‡æ›¿æ¢
find . -type f \( -name "*.ts" -o -name "*.tsx" \) \
  -not -path "./node_modules/*" \
  -not -path "./mksaas_template-cloudflare/*" \
  -exec sed -i '' 's/@\/src\//@\//g' {} +
```

**éªŒè¯å¯¼å…¥è·¯å¾„**:
```bash
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é”™è¯¯çš„å¯¼å…¥è·¯å¾„
grep -r "@/src/" --include="*.ts" --include="*.tsx" \
  --exclude-dir=node_modules \
  --exclude-dir=mksaas_template-cloudflare
# åº”è¯¥æ²¡æœ‰è¾“å‡º,å¦‚æœæœ‰åˆ™éœ€è¦æ‰‹åŠ¨ä¿®æ­£
```

### Phase 3: æ•°æ®åº“åˆå§‹åŒ– (0.5å¤©)

```bash
# 1. ç”Ÿæˆè¿ç§»æ–‡ä»¶
npx drizzle-kit generate

# 2. æŸ¥çœ‹ç”Ÿæˆçš„SQL
cat db/migrations/0000_*.sql

# 3. æ‰§è¡Œè¿ç§»
npx drizzle-kit migrate

# 4. éªŒè¯è¡¨ç»“æ„
npx drizzle-kit studio
# åœ¨æµè§ˆå™¨æ‰“å¼€ https://local.drizzle.studio
```

### Phase 4: è®¤è¯åŠŸèƒ½å®ç° (2å¤©)

#### 4.1 åˆ›å»ºAPIè·¯ç”±

**æ–‡ä»¶**: `app/api/auth/[...all]/route.ts`

```typescript
import { auth } from '@/lib/auth';
import { toNextJsHandler } from "better-auth/next-js";

export const { GET, POST } = toNextJsHandler(auth);
```

#### 4.2 åˆ›å»ºè®¤è¯é¡µé¢

**ç™»å½•é¡µ**: `app/(auth)/login/page.tsx`

```typescript
import { LoginForm } from '@/components/auth/login-form';
import { Suspense } from 'react';

export default function LoginPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-amber-50 to-white">
      <div className="w-full max-w-md px-4">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            ç™»å½•åˆ°é˜¿æ‹‰ä¼¯ä¹¦æ³•ç”Ÿæˆå™¨
          </h1>
          <p className="text-gray-600">
            ä½¿ç”¨ä½ çš„è´¦å·ç»§ç»­ä½¿ç”¨
          </p>
        </div>
        
        <Suspense fallback={<div>Loading...</div>}>
          <LoginForm />
        </Suspense>
        
        <p className="text-center mt-4 text-sm text-gray-600">
          è¿˜æ²¡æœ‰è´¦å·?{' '}
          <a href="/register" className="text-amber-600 hover:text-amber-700">
            ç«‹å³æ³¨å†Œ
          </a>
        </p>
      </div>
    </div>
  );
}
```

**æ³¨å†Œé¡µ**: `app/(auth)/register/page.tsx` (ç±»ä¼¼ç»“æ„)

#### 4.3 åˆ›å»ºè®¤è¯ç»„ä»¶

**æ–‡ä»¶**: `components/auth/login-form.tsx` (ä»mksaaså¤åˆ¶å¹¶è°ƒæ•´)

ä¸»è¦åŠŸèƒ½:
- Email + Passwordç™»å½•
- OAuthç™»å½•æŒ‰é’®
- é”™è¯¯å¤„ç†
- åŠ è½½çŠ¶æ€
- é‡å®šå‘å¤„ç†

#### å¯¼èˆªæ é›†æˆ

âš ï¸ **å…³é”®ä¿®æ­£**: ä½¿ç”¨next-intlçš„Linkå’ŒuseLocale,ä¸å†™æ­»è·¯å¾„

**æ–‡ä»¶**: `components/navbar.tsx` (ä¿®æ”¹ç°æœ‰æ–‡ä»¶)

```typescript
'use client';

import { authClient } from '@/lib/auth-client';
import { useSubscriptionStatus } from '@/hooks/use-subscription';
import Link from 'next/link';
import { useLocale } from 'next-intl';

export function Navbar() {
  const { data: session } = authClient.useSession();
  const { isPro } = useSubscriptionStatus();
  const locale = useLocale();

  return (
    <nav>
      {/* Logo */}
      <Link href={`/${locale}/`}>...</Link>
      
      {/* å¯¼èˆªé“¾æ¥ */}
      <Link href={`/${locale}/pricing`}>
        {t('nav.pricing')}
      </Link>
      
      {/* ç”¨æˆ·èœå• */}
      {session?.user ? (
        <DropdownMenu>
          <DropdownMenuTrigger>
            <Avatar>
              <AvatarImage src={session.user.image} />
              <AvatarFallback>{session.user.name?.[0]}</AvatarFallback>
            </Avatar>
          </DropdownMenuTrigger>
          <DropdownMenuContent>
            <DropdownMenuItem>
              <Link href={`/${locale}/dashboard`}>
                {t('nav.dashboard')}
              </Link>
            </DropdownMenuItem>
            {!isPro && (
              <DropdownMenuItem>
                <Link href={`/${locale}/pricing`} className="text-amber-600 font-semibold">
                  âš¡ {t('nav.upgradeToPro')}
                </Link>
              </DropdownMenuItem>
            )}
            <DropdownMenuItem onClick={() => authClient.signOut()}>
              {t('nav.signOut')}
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      ) : (
        <div className="flex gap-2">
          <Button variant="ghost" asChild>
            <Link href={`/${locale}/login`}>{t('nav.login')}</Link>
          </Button>
          <Button asChild>
            <Link href={`/${locale}/register`}>{t('nav.register')}</Link>
          </Button>
        </div>
      )}
    </nav>
  );
}
```

### 2. å®šä»·é¡µé¢ç»„ä»¶

âš ï¸ **PricingCardç»„ä»¶ç”¨æ³•ä¿®æ­£**: å‚è€ƒmksaaså®é™…props

**æ–‡ä»¶**: `app/[locale]/pricing/page.tsx` (æ–°å»º)

```typescript
import { getPricePlans } from '@/config/price-config';
import { PricingCard } from '@/components/payment/pricing-card';
import { PlanIntervals, PaymentTypes } from '@/payment/types';

export default function PricingPage() {
  // ä»é…ç½®è·å–è®¡åˆ’(å®¢æˆ·ç«¯ç»„ä»¶)
  const plans = getPricePlans();

  return (
    <div className="container mx-auto py-16">
      <h1 className="text-4xl font-bold text-center mb-12">
        Choose Your Plan
      </h1>
      
      <div className="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
        {/* Freeè®¡åˆ’ */}
        <PricingCard
          plan={plans.free}
          // Freeè®¡åˆ’ä¸éœ€è¦intervalå‚æ•°
        />
        
        {/* Proè®¡åˆ’ - âš ï¸ åªä¼ planå’Œinterval */}
        <PricingCard
          plan={plans.pro}
          interval={PlanIntervals.YEAR}
          // paymentTypeä¼šè‡ªåŠ¨è¯†åˆ«ä¸ºSUBSCRIPTION
        />
      </div>
    </div>
  );
}
```

**è¯´æ˜**:
- `PricingCard` ç»„ä»¶props: `plan: PricePlan`, `interval?: PlanInterval`, `paymentType?: PaymentType`, `metadata?: Record<string, string>`, `className?: string`, `isCurrentPlan?: boolean`
- ä¸è¦ä¼  `planId`/`priceId` ç­‰å•ç‹¬å‚æ•°,æ‰€æœ‰ä¿¡æ¯ä» `plan` å¯¹è±¡è·å–
- UIæ–‡æ¡ˆ(name/description/features)é€šè¿‡ `getPricePlans()` è‡ªåŠ¨æ³¨å…¥å¤šè¯­è¨€
- `interval` ç”¨äºåœ¨å¤šä¸ªä»·æ ¼é€‰é¡¹ä¸­é€‰æ‹©(å¦‚æœˆä»˜/å¹´ä»˜),Proå¹´ä»˜ä¼  `PlanIntervals.YEAR`

#### PNGä¸‹è½½ - æ·»åŠ æ°´å°

âš ï¸ **å…³é”®**: ä½¿ç”¨hookè·å–çš„è®¢é˜…çŠ¶æ€,ä¸åœ¨å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨æ•°æ®åº“å‡½æ•°

**æ–‡ä»¶**: `components/calligraphy-generator.tsx` (ä¿®æ”¹)

```typescript
const handleDownloadPNG = async () => {
  // âœ… ä»hookè·å–è®¢é˜…çŠ¶æ€(å·²ç»åœ¨ç»„ä»¶ä¸­å®šä¹‰)
  // const { isPro } = useSubscriptionStatus();
  
  // ç”Ÿæˆcanvas
  const canvas = await generatePreviewCanvas(previewRef.current, currentOptions, 4);
  
  // å¦‚æœä¸æ˜¯Proç”¨æˆ·,æ·»åŠ æ°´å°
  if (!isPro) {
    const ctx = canvas.getContext('2d');
    if (ctx) {
      // æ·»åŠ åŠé€æ˜æ°´å°
      ctx.globalAlpha = 0.3;
      ctx.font = '24px Arial';
      ctx.fillStyle = '#666666';
      ctx.textAlign = 'center';
      ctx.fillText('arabic-calligraphy-generator.com', canvas.width / 2, canvas.height - 30);
      ctx.globalAlpha = 1.0;
    }
  }
  
  // ä¸‹è½½
  const dataUrl = canvas.toDataURL('image/png', 1.0);
  // ...
};
```

---

## å®æ–½æ­¥éª¤

### Phase 1: ç¯å¢ƒå‡†å¤‡ (1å¤©)

#### 1.1 æ•°æ®åº“é…ç½®

```bash
# 1. æ³¨å†ŒNeonè´¦å·: https://neon.tech
# 2. åˆ›å»ºæ–°é¡¹ç›®: arabic-calligraphy-generator
# 3. è·å–è¿æ¥å­—ç¬¦ä¸²
# 4. æ·»åŠ åˆ°.env.local

DATABASE_URL="postgresql://user:password@host/database?sslmode=require"
```

#### 1.2 å®‰è£…ä¾èµ–

```bash
cd /Users/qiuweisen/CascadeProjects/arabic-calligraphy-creator

# å®‰è£…æ ¸å¿ƒä¾èµ–
npm install better-auth drizzle-orm @neondatabase/serverless stripe date-fns

# å®‰è£…å¼€å‘ä¾èµ–
npm install -D drizzle-kit
```

#### 1.3 é…ç½®Stripe

```bash
# 1. ç™»å½•Stripe Dashboard: https://dashboard.stripe.com
# 2. åˆ›å»ºäº§å“: Pro Subscription
# 3. åˆ›å»ºä»·æ ¼: $29.99/year
# 4. è·å–APIå¯†é’¥å’ŒPrice ID
# 5. é…ç½®Webhook endpoint: https://your-domain.com/api/payment/webhook
# 6. æ·»åŠ åˆ°.env.local

STRIPE_SECRET_KEY="sk_test_..."
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_..."
STRIPE_WEBHOOK_SECRET="whsec_..."
STRIPE_PRICE_ID_PRO_YEARLY="price_..."
```

### Phase 2: æ–‡ä»¶è¿ç§» (1-2å¤©)

#### 2.1 å¤åˆ¶æ ¸å¿ƒæ¨¡å—

âš ï¸ **é‡è¦**: ä½¿ç”¨æ­£ç¡®çš„ç›®å½•ç»“æ„,ä¿æŒä¸ç°æœ‰é¡¹ç›®ä¸€è‡´

```bash
# ä»mksaaså¤åˆ¶åˆ°å½“å‰é¡¹ç›®
cd /Users/qiuweisen/CascadeProjects/arabic-calligraphy-creator

# 1. å¤åˆ¶è®¤è¯æ¨¡å— (lib/auth*)
cp mksaas_template-cloudflare/src/lib/auth.ts lib/
cp mksaas_template-cloudflare/src/lib/auth-client.ts lib/

# 2. å¤åˆ¶URLå·¥å…· (authä¾èµ–)
mkdir -p lib/urls
cp mksaas_template-cloudflare/src/lib/urls/urls.ts lib/urls/

# 3. å¤åˆ¶æ”¯ä»˜æ¨¡å— (æ•´ä¸ªç›®å½•)
cp -r mksaas_template-cloudflare/src/payment ./

# 4. å¤åˆ¶ç§¯åˆ†æ¨¡å—(é¢„ç•™,æ•´ä¸ªç›®å½•)
cp -r mksaas_template-cloudflare/src/credits ./

# 5. å¤åˆ¶æ•°æ®åº“æ¨¡å—
cp -r mksaas_template-cloudflare/src/db ./

# 6. å¤åˆ¶é…ç½®æ–‡ä»¶
cp mksaas_template-cloudflare/src/config/website.tsx config/
cp mksaas_template-cloudflare/src/config/price-config.tsx config/
cp mksaas_template-cloudflare/src/config/credits-config.tsx config/ # å¯é€‰

# 7. å¤åˆ¶å·¥å…·å‡½æ•°
cp mksaas_template-cloudflare/src/lib/price-plan.ts lib/

# 8. å¤åˆ¶é‚®ä»¶æ¨¡å—(authçš„é‚®ç®±éªŒè¯éœ€è¦)
mkdir -p mail
cp -r mksaas_template-cloudflare/src/mail/* mail/
```

**å¤åˆ¶åçš„ç›®å½•ç»“æ„éªŒè¯**:
```bash
# éªŒè¯å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la lib/auth.ts lib/auth-client.ts
ls -la payment/index.ts payment/provider/stripe.ts
ls -la db/index.ts db/schema.ts
ls -la config/website.tsx config/price-config.tsx
```

#### 2.2 åˆ›å»ºé…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `config/subscription.ts`

```typescript
// å‰é¢å·²å®šä¹‰,å‚è€ƒ"è®¢é˜…è®¡åˆ’é…ç½®"éƒ¨åˆ†
```

**æ–‡ä»¶**: `drizzle.config.ts`

```typescript
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'postgresql',
  schema: './db/schema.ts',
  out: './db/migrations',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

#### 2.3 è°ƒæ•´å¯¼å…¥è·¯å¾„

âš ï¸ **å…³é”®æ­¥éª¤**: ç”±äºmksaasä½¿ç”¨ `src/` ç»“æ„,éœ€è¦æ‰¹é‡è°ƒæ•´å¯¼å…¥è·¯å¾„

```bash
# åœ¨æ‰€æœ‰å¤åˆ¶çš„æ–‡ä»¶ä¸­,å°†å¯¼å…¥è·¯å¾„è°ƒæ•´ä¸ºé¡¹ç›®çš„æ ¹ç›®å½•ç»“æ„
# ä¸éœ€è¦æ”¹tsconfig,å› ä¸º@/*å·²ç»æŒ‡å‘./

# ç¤ºä¾‹: lib/auth.ts ä¸­çš„å¯¼å…¥éœ€è¦ä»
# import { websiteConfig } from '@/config/website';
# ä¿æŒä¸å˜(å› ä¸º@/å·²ç»æŒ‡å‘æ ¹ç›®å½•)

# ä½†æ˜¯mksaasä¸­å¯èƒ½æœ‰ import from '@/src/...'
# éœ€è¦å»æ‰ /src éƒ¨åˆ†

# ä½¿ç”¨VS Codeå…¨å±€æœç´¢æ›¿æ¢:
# æœç´¢: from '@/src/
# æ›¿æ¢ä¸º: from '@/

# æˆ–è€…ä½¿ç”¨å‘½ä»¤è¡Œæ‰¹é‡æ›¿æ¢
find . -type f \( -name "*.ts" -o -name "*.tsx" \) \
  -not -path "./node_modules/*" \
  -not -path "./mksaas_template-cloudflare/*" \
  -exec sed -i '' 's/@\/src\//@\//g' {} +
```

**éªŒè¯å¯¼å…¥è·¯å¾„**:
```bash
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é”™è¯¯çš„å¯¼å…¥è·¯å¾„
grep -r "@/src/" --include="*.ts" --include="*.tsx" \
  --exclude-dir=node_modules \
  --exclude-dir=mksaas_template-cloudflare
# åº”è¯¥æ²¡æœ‰è¾“å‡º,å¦‚æœæœ‰åˆ™éœ€è¦æ‰‹åŠ¨ä¿®æ­£
```

### Phase 3: æ•°æ®åº“åˆå§‹åŒ– (0.5å¤©)

```bash
# 1. ç”Ÿæˆè¿ç§»æ–‡ä»¶
npx drizzle-kit generate

# 2. æŸ¥çœ‹ç”Ÿæˆçš„SQL
cat db/migrations/0000_*.sql

# 3. æ‰§è¡Œè¿ç§»
npx drizzle-kit migrate

# 4. éªŒè¯è¡¨ç»“æ„
npx drizzle-kit studio
# åœ¨æµè§ˆå™¨æ‰“å¼€ https://local.drizzle.studio
```

### Phase 4: è®¤è¯åŠŸèƒ½å®ç° (2å¤©)

#### 4.1 åˆ›å»ºAPIè·¯ç”±

**æ–‡ä»¶**: `app/api/auth/[...all]/route.ts`

```typescript
import { auth } from '@/lib/auth';
import { toNextJsHandler } from "better-auth/next-js";

export const { GET, POST } = toNextJsHandler(auth);
```

#### 4.2 åˆ›å»ºè®¤è¯é¡µé¢

**ç™»å½•é¡µ**: `app/(auth)/login/page.tsx`

```typescript
import { LoginForm } from '@/components/auth/login-form';
import { Suspense } from 'react';

export default function LoginPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-amber-50 to-white">
      <div className="w-full max-w-md px-4">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            ç™»å½•åˆ°é˜¿æ‹‰ä¼¯ä¹¦æ³•ç”Ÿæˆå™¨
          </h1>
          <p className="text-gray-600">
            ä½¿ç”¨ä½ çš„è´¦å·ç»§ç»­ä½¿ç”¨
          </p>
        </div>
        
        <Suspense fallback={<div>Loading...</div>}>
          <LoginForm />
        </Suspense>
        
        <p className="text-center mt-4 text-sm text-gray-600">
          è¿˜æ²¡æœ‰è´¦å·?{' '}
          <a href="/register" className="text-amber-600 hover:text-amber-700">
            ç«‹å³æ³¨å†Œ
          </a>
        </p>
      </div>
    </div>
  );
}
```

**æ³¨å†Œé¡µ**: `app/(auth)/register/page.tsx` (ç±»ä¼¼ç»“æ„)

#### 4.3 åˆ›å»ºè®¤è¯ç»„ä»¶

**æ–‡ä»¶**: `components/auth/login-form.tsx` (ä»mksaaså¤åˆ¶å¹¶è°ƒæ•´)

ä¸»è¦åŠŸèƒ½:
- Email + Passwordç™»å½•
- OAuthç™»å½•æŒ‰é’®
- é”™è¯¯å¤„ç†
- åŠ è½½çŠ¶æ€
- é‡å®šå‘å¤„ç†

#### å¯¼èˆªæ é›†æˆ

âš ï¸ **å…³é”®ä¿®æ­£**: ä½¿ç”¨next-intlçš„Linkå’ŒuseLocale,ä¸å†™æ­»è·¯å¾„

**æ–‡ä»¶**: `components/navbar.tsx` (ä¿®æ”¹ç°æœ‰æ–‡ä»¶)

```typescript
'use client';

import { authClient } from '@/lib/auth-client';
import { useSubscriptionStatus } from '@/hooks/use-subscription';
import Link from 'next/link';
import { useLocale } from 'next-intl';

export function Navbar() {
  const { data: session } = authClient.useSession();
  const { isPro } = useSubscriptionStatus();
  const locale = useLocale();

  return (
    <nav>
      {/* Logo */}
      <Link href={`/${locale}/`}>...</Link>
      
      {/* å¯¼èˆªé“¾æ¥ */}
      <Link href={`/${locale}/pricing`}>
        {t('nav.pricing')}
      </Link>
      
      {/* ç”¨æˆ·èœå• */}
      {session?.user ? (
        <DropdownMenu>
          <DropdownMenuTrigger>
            <Avatar>
              <AvatarImage src={session.user.image} />
              <AvatarFallback>{session.user.name?.[0]}</AvatarFallback>
            </Avatar>
          </DropdownMenuTrigger>
          <DropdownMenuContent>
            <DropdownMenuItem>
              <Link href={`/${locale}/dashboard`}>
                {t('nav.dashboard')}
              </Link>
            </DropdownMenuItem>
            {!isPro && (
              <DropdownMenuItem>
                <Link href={`/${locale}/pricing`} className="text-amber-600 font-semibold">
                  âš¡ {t('nav.upgradeToPro')}
                </Link>
              </DropdownMenuItem>
            )}
            <DropdownMenuItem onClick={() => authClient.signOut()}>
              {t('nav.signOut')}
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      ) : (
        <div className="flex gap-2">
          <Button variant="ghost" asChild>
            <Link href={`/${locale}/login`}>{t('nav.login')}</Link>
          </Button>
          <Button asChild>
            <Link href={`/${locale}/register`}>{t('nav.register')}</Link>
          </Button>
        </div>
      )}
    </nav>
  );
}
```

### 2. å®šä»·é¡µé¢ç»„ä»¶

âš ï¸ **PricingCardç»„ä»¶ç”¨æ³•ä¿®æ­£**: å‚è€ƒmksaaså®é™…props

**æ–‡ä»¶**: `app/[locale]/pricing/page.tsx` (æ–°å»º)

```typescript
import { getPricePlans } from '@/config/price-config';
import { PricingCard } from '@/components/payment/pricing-card';
import { PlanIntervals, PaymentTypes } from '@/payment/types';

export default function PricingPage() {
  // ä»é…ç½®è·å–è®¡åˆ’(å®¢æˆ·ç«¯ç»„ä»¶)
  const plans = getPricePlans();

  return (
    <div className="container mx-auto py-16">
      <h1 className="text-4xl font-bold text-center mb-12">
        Choose Your Plan
      </h1>
      
      <div className="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
        {/* Freeè®¡åˆ’ */}
        <PricingCard
          plan={plans.free}
          // Freeè®¡åˆ’ä¸éœ€è¦intervalå‚æ•°
        />
        
        {/* Proè®¡åˆ’ - âš ï¸ åªä¼ planå’Œinterval */}
        <PricingCard
          plan={plans.pro}
          interval={PlanIntervals.YEAR}
          // paymentTypeä¼šè‡ªåŠ¨è¯†åˆ«ä¸ºSUBSCRIPTION
        />
      </div>
    </div>
  );
}
```

**è¯´æ˜**:
- `PricingCard` ç»„ä»¶props: `plan: PricePlan`, `interval?: PlanInterval`, `paymentType?: PaymentType`, `metadata?: Record<string, string>`, `className?: string`, `isCurrentPlan?: boolean`
- ä¸è¦ä¼  `planId`/`priceId` ç­‰å•ç‹¬å‚æ•°,æ‰€æœ‰ä¿¡æ¯ä» `plan` å¯¹è±¡è·å–
- UIæ–‡æ¡ˆ(name/description/features)é€šè¿‡ `getPricePlans()` è‡ªåŠ¨æ³¨å…¥å¤šè¯­è¨€
- `interval` ç”¨äºåœ¨å¤šä¸ªä»·æ ¼é€‰é¡¹ä¸­é€‰æ‹©(å¦‚æœˆä»˜/å¹´ä»˜),Proå¹´ä»˜ä¼  `PlanIntervals.YEAR`

#### PNGä¸‹è½½ - æ·»åŠ æ°´å°

âš ï¸ **å…³é”®**: ä½¿ç”¨hookè·å–çš„è®¢é˜…çŠ¶æ€,ä¸åœ¨å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨æ•°æ®åº“å‡½æ•°

**æ–‡ä»¶**: `components/calligraphy-generator.tsx` (ä¿®æ”¹)

```typescript
const handleDownloadPNG = async () => {
  // âœ… ä»hookè·å–è®¢é˜…çŠ¶æ€(å·²ç»åœ¨ç»„ä»¶ä¸­å®šä¹‰)
  // const { isPro } = useSubscriptionStatus();
  
  // ç”Ÿæˆcanvas
  const canvas = await generatePreviewCanvas(previewRef.current, currentOptions, 4);
  
  // å¦‚æœä¸æ˜¯Proç”¨æˆ·,æ·»åŠ æ°´å°
  if (!isPro) {
    const ctx = canvas.getContext('2d');
    if (ctx) {
      // æ·»åŠ åŠé€æ˜æ°´å°
      ctx.globalAlpha = 0.3;
      ctx.font = '24px Arial';
      ctx.fillStyle = '#666666';
      ctx.textAlign = 'center';
      ctx.fillText('arabic-calligraphy-generator.com', canvas.width / 2, canvas.height - 30);
      ctx.globalAlpha = 1.0;
    }
  }
  
  // ä¸‹è½½
  const dataUrl = canvas.toDataURL('image/png', 1.0);
  // ...
};
```

---

## å®æ–½æ­¥éª¤

### Phase 1: ç¯å¢ƒå‡†å¤‡ (1å¤©)

#### 1.1 æ•°æ®åº“é…ç½®

```bash
# 1. æ³¨å†ŒNeonè´¦å·: https://neon.tech
# 2. åˆ›å»ºæ–°é¡¹ç›®: arabic-calligraphy-generator
# 3. è·å–è¿æ¥å­—ç¬¦ä¸²
# 4. æ·»åŠ åˆ°.env.local

DATABASE_URL="postgresql://user:password@host/database?sslmode=require"
```

#### 1.2 å®‰è£…ä¾èµ–

```bash
cd /Users/qiuweisen/CascadeProjects/arabic-calligraphy-creator

# å®‰è£…æ ¸å¿ƒä¾èµ–
npm install better-auth drizzle-orm @neondatabase/serverless stripe date-fns

# å®‰è£…å¼€å‘ä¾èµ–
npm install -D drizzle-kit
```

#### 1.3 é…ç½®Stripe

```bash
# 1. ç™»å½•Stripe Dashboard: https://dashboard.stripe.com
# 2. åˆ›å»ºäº§å“: Pro Subscription
# 3. åˆ›å»ºä»·æ ¼: $29.99/year
# 4. è·å–APIå¯†é’¥å’ŒPrice ID
# 5. é…ç½®Webhook endpoint: https://your-domain.com/api/payment/webhook
# 6. æ·»åŠ åˆ°.env.local

STRIPE_SECRET_KEY="sk_test_..."
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_..."
STRIPE_WEBHOOK_SECRET="whsec_..."
STRIPE_PRICE_ID_PRO_YEARLY="price_..."
```

### Phase 2: æ–‡ä»¶è¿ç§» (1-2å¤©)

#### 2.1 å¤åˆ¶æ ¸å¿ƒæ¨¡å—

âš ï¸ **é‡è¦**: ä½¿ç”¨æ­£ç¡®çš„ç›®å½•ç»“æ„,ä¿æŒä¸ç°æœ‰é¡¹ç›®ä¸€è‡´

```bash
# ä»mksaaså¤åˆ¶åˆ°å½“å‰é¡¹ç›®
cd /Users/qiuweisen/CascadeProjects/arabic-calligraphy-creator

# 1. å¤åˆ¶è®¤è¯æ¨¡å— (lib/auth*)
cp mksaas_template-cloudflare/src/lib/auth.ts lib/
cp mksaas_template-cloudflare/src/lib/auth-client.ts lib/

# 2. å¤åˆ¶URLå·¥å…· (authä¾èµ–)
mkdir -p lib/urls
cp mksaas_template-cloudflare/src/lib/urls/urls.ts lib/urls/

# 3. å¤åˆ¶æ”¯ä»˜æ¨¡å— (æ•´ä¸ªç›®å½•)
cp -r mksaas_template-cloudflare/src/payment ./

# 4. å¤åˆ¶ç§¯åˆ†æ¨¡å—(é¢„ç•™,æ•´ä¸ªç›®å½•)
cp -r mksaas_template-cloudflare/src/credits ./

# 5. å¤åˆ¶æ•°æ®åº“æ¨¡å—
cp -r mksaas_template-cloudflare/src/db ./

# 6. å¤åˆ¶é…ç½®æ–‡ä»¶
cp mksaas_template-cloudflare/src/config/website.tsx config/
cp mksaas_template-cloudflare/src/config/price-config.tsx config/
cp mksaas_template-cloudflare/src/config/credits-config.tsx config/ # å¯é€‰

# 7. å¤åˆ¶å·¥å…·å‡½æ•°
cp mksaas_template-cloudflare/src/lib/price-plan.ts lib/

# 8. å¤åˆ¶é‚®ä»¶æ¨¡å—(authçš„é‚®ç®±éªŒè¯éœ€è¦)
mkdir -p mail
cp -r mksaas_template-cloudflare/src/mail/* mail/
```

**å¤åˆ¶åçš„ç›®å½•ç»“æ„éªŒè¯**:
```bash
# éªŒè¯å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la lib/auth.ts lib/auth-client.ts
ls -la payment/index.ts payment/provider/stripe.ts
ls -la db/index.ts db/schema.ts
ls -la config/website.tsx config/price-config.tsx
```

#### 2.2 åˆ›å»ºé…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `config/subscription.ts`

```typescript
// å‰é¢å·²å®šä¹‰,å‚è€ƒ"è®¢é˜…è®¡åˆ’é…ç½®"éƒ¨åˆ†
```

**æ–‡ä»¶**: `drizzle.config.ts`

```typescript
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'postgresql',
  schema: './db/schema.ts',
  out: './db/migrations',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

#### 2.3 è°ƒæ•´å¯¼å…¥è·¯å¾„

âš ï¸ **å…³é”®æ­¥éª¤**: ç”±äºmksaasä½¿ç”¨ `src/` ç»“æ„,éœ€è¦æ‰¹é‡è°ƒæ•´å¯¼å…¥è·¯å¾„

```bash
# åœ¨æ‰€æœ‰å¤åˆ¶çš„æ–‡ä»¶ä¸­,å°†å¯¼å…¥è·¯å¾„è°ƒæ•´ä¸ºé¡¹ç›®çš„æ ¹ç›®å½•ç»“æ„
# ä¸éœ€è¦æ”¹tsconfig,å› ä¸º@/*å·²ç»æŒ‡å‘./

# ç¤ºä¾‹: lib/auth.ts ä¸­çš„å¯¼å…¥éœ€è¦ä»
# import { websiteConfig } from '@/config/website';
# ä¿æŒä¸å˜(å› ä¸º@/å·²ç»æŒ‡å‘æ ¹ç›®å½•)

# ä½†æ˜¯mksaasä¸­å¯èƒ½æœ‰ import from '@/src/...'
# éœ€è¦å»æ‰ /src éƒ¨åˆ†

# ä½¿ç”¨VS Codeå…¨å±€æœç´¢æ›¿æ¢:
# æœç´¢: from '@/src/
# æ›¿æ¢ä¸º: from '@/

# æˆ–è€…ä½¿ç”¨å‘½ä»¤è¡Œæ‰¹é‡æ›¿æ¢
find . -type f \( -name "*.ts" -o -name "*.tsx" \) \
  -not -path "./node_modules/*" \
  -not -path "./mksaas_template-cloudflare/*" \
  -exec sed -i '' 's/@\/src\//@\//g' {} +
```

**éªŒè¯å¯¼å…¥è·¯å¾„**:
```bash
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é”™è¯¯çš„å¯¼å…¥è·¯å¾„
grep -r "@/src/" --include="*.ts" --include="*.tsx" \
  --exclude-dir=node_modules \
  --exclude-dir=mksaas_template-cloudflare
# åº”è¯¥æ²¡æœ‰è¾“å‡º,å¦‚æœæœ‰åˆ™éœ€è¦æ‰‹åŠ¨ä¿®æ­£
```

### Phase 3: æ•°æ®åº“åˆå§‹åŒ– (0.5å¤©)

```bash
# 1. ç”Ÿæˆè¿ç§»æ–‡ä»¶
npx drizzle-kit generate

# 2. æŸ¥çœ‹ç”Ÿæˆçš„SQL
cat db/migrations/0000_*.sql

# 3. æ‰§è¡Œè¿ç§»
npx drizzle-kit migrate

# 4. éªŒè¯è¡¨ç»“æ„
npx drizzle-kit studio
# åœ¨æµè§ˆå™¨æ‰“å¼€ https://local.drizzle.studio
```

### Phase 4: è®¤è¯åŠŸèƒ½å®ç° (2å¤©)

#### 4.1 åˆ›å»ºAPIè·¯ç”±

**æ–‡ä»¶**: `app/api/auth/[...all]/route.ts`

```typescript
import { auth } from '@/lib/auth';
import { toNextJsHandler } from "better-auth/next-js";

export const { GET, POST } = toNextJsHandler(auth);
```

#### 4.2 åˆ›å»ºè®¤è¯é¡µé¢

**ç™»å½•é¡µ**: `app/(auth)/login/page.tsx`

```typescript
import { LoginForm } from '@/components/auth/login-form';
import { Suspense } from 'react';

export default function LoginPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-amber-50 to-white">
      <div className="w-full max-w-md px-4">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            ç™»å½•åˆ°é˜¿æ‹‰ä¼¯ä¹¦æ³•ç”Ÿæˆå™¨
          </h1>
          <p className="text-gray-600">
            ä½¿ç”¨ä½ çš„è´¦å·ç»§ç»­ä½¿ç”¨
          </p>
        </div>
        
        <Suspense fallback={<div>Loading...</div>}>
          <LoginForm />
        </Suspense>
        
        <p className="text-center mt-4 text-sm text-gray-600">
          è¿˜æ²¡æœ‰è´¦å·?{' '}
          <a href="/register" className="text-amber-600 hover:text-amber-700">
            ç«‹å³æ³¨å†Œ
          </a>
        </p>
      </div>
    </div>
  );
}
```

**æ³¨å†Œé¡µ**: `app/(auth)/register/page.tsx` (ç±»ä¼¼ç»“æ„)

#### 4.3 åˆ›å»ºè®¤è¯ç»„ä»¶

**æ–‡ä»¶**: `components/auth/login-form.tsx` (ä»mksaaså¤åˆ¶å¹¶è°ƒæ•´)

ä¸»è¦åŠŸèƒ½:
- Email + Passwordç™»å½•
- OAuthç™»å½•æŒ‰é’®
- é”™è¯¯å¤„ç†
- åŠ è½½çŠ¶æ€
- é‡å®šå‘å¤„ç†

#### å¯¼èˆªæ é›†æˆ

âš ï¸ **å…³é”®ä¿®æ­£**: ä½¿ç”¨next-intlçš„Linkå’ŒuseLocale,ä¸å†™æ­»è·¯å¾„

**æ–‡ä»¶**: `components/navbar.tsx` (ä¿®æ”¹ç°æœ‰æ–‡ä»¶)

```typescript
'use client';

import { authClient } from '@/lib/auth-client';
import { useSubscriptionStatus } from '@/hooks/use-subscription';
import Link from 'next/link';
import { useLocale } from 'next-intl';

export function Navbar() {
  const { data: session } = authClient.useSession();
  const { isPro } = useSubscriptionStatus();
  const locale = useLocale();

  return (
    <nav>
      {/* Logo */}
      <Link href={`/${locale}/`}>...</Link>
      
      {/* å¯¼èˆªé“¾æ¥ */}
      <Link href={`/${locale}/pricing`}>
        {t('nav.pricing')}
      </Link>
      
      {/* ç”¨æˆ·èœå• */}
      {session?.user ? (
        <DropdownMenu>
          <DropdownMenuTrigger>
            <Avatar>
              <AvatarImage src={session.user.image} />
              <AvatarFallback>{session.user.name?.[0]}</AvatarFallback>
            </Avatar>
          </DropdownMenuTrigger>
          <DropdownMenuContent>
            <DropdownMenuItem>
              <Link href={`/${locale}/dashboard`}>
                {t('nav.dashboard')}
              </Link>
            </DropdownMenuItem>
            {!isPro && (
              <DropdownMenuItem>
                <Link href={`/${locale}/pricing`} className="text-amber-600 font-semibold">
                  âš¡ {t('nav.upgradeToPro')}
                </Link>
              </DropdownMenuItem>
            )}
            <DropdownMenuItem onClick={() => authClient.signOut()}>
              {t('nav.signOut')}
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      ) : (
        <div className="flex gap-2">
          <Button variant="ghost" asChild>
            <Link href={`/${locale}/login`}>{t('nav.login')}</Link>
          </Button>
          <Button asChild>
            <Link href={`/${locale}/register`}>{t('nav.register')}</Link>
          </Button>
        </div>
      )}
    </nav>
  );
}
```

### 2. å®šä»·é¡µé¢ç»„ä»¶

âš ï¸ **PricingCardç»„ä»¶ç”¨æ³•ä¿®æ­£**: å‚è€ƒmksaaså®é™…props

**æ–‡ä»¶**: `app/[locale]/pricing/page.tsx` (æ–°å»º)

```typescript
import { getPricePlans } from '@/config/price-config';
import { PricingCard } from '@/components/payment/pricing-card';
import { PlanIntervals, PaymentTypes } from '@/payment/types';

export default function PricingPage() {
  // ä»é…ç½®è·å–è®¡åˆ’(å®¢æˆ·ç«¯ç»„ä»¶)
  const plans = getPricePlans();

  return (
    <div className="container mx-auto py-16">
      <h1 className="text-4xl font-bold text-center mb-12">
        Choose Your Plan
      </h1>
      
      <div className="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
        {/* Freeè®¡åˆ’ */}
        <PricingCard
          plan={plans.free}
          // Freeè®¡åˆ’ä¸éœ€è¦intervalå‚æ•°
        />
        
        {/* Proè®¡åˆ’ - âš ï¸ åªä¼ planå’Œinterval */}
        <PricingCard
          plan={plans.pro}
          interval={PlanIntervals.YEAR}
          // paymentTypeä¼šè‡ªåŠ¨è¯†åˆ«ä¸ºSUBSCRIPTION
        />
      </div>
    </div>
  );
}
```

**è¯´æ˜**:
- `PricingCard` ç»„ä»¶props: `plan: PricePlan`, `interval?: PlanInterval`, `paymentType?: PaymentType`, `metadata?: Record<string, string>`, `className?: string`, `isCurrentPlan?: boolean`
- ä¸è¦ä¼  `planId`/`priceId` ç­‰å•ç‹¬å‚æ•°,æ‰€æœ‰ä¿¡æ¯ä» `plan` å¯¹è±¡è·å–
- UIæ–‡æ¡ˆ(name/description/features)é€šè¿‡ `getPricePlans()` è‡ªåŠ¨æ³¨å…¥å¤šè¯­è¨€
- `interval` ç”¨äºåœ¨å¤šä¸ªä»·æ ¼é€‰é¡¹ä¸­é€‰æ‹©(å¦‚æœˆä»˜/å¹´ä»˜),Proå¹´ä»˜ä¼  `PlanIntervals.YEAR`

#### PNGä¸‹è½½ - æ·»åŠ æ°´å°

âš ï¸ **å…³é”®**: ä½¿ç”¨hookè·å–çš„è®¢é˜…çŠ¶æ€,ä¸åœ¨å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨æ•°æ®åº“å‡½æ•°

**æ–‡ä»¶**: `components/calligraphy-generator.tsx` (ä¿®æ”¹)

```typescript
const handleDownloadPNG = async () => {
  // âœ… ä»hookè·å–è®¢é˜…çŠ¶æ€(å·²ç»åœ¨ç»„ä»¶ä¸­å®šä¹‰)
  // const { isPro } = useSubscriptionStatus();
  
  // ç”Ÿæˆcanvas
  const canvas = await generatePreviewCanvas(previewRef.current, currentOptions, 4);
  
  // å¦‚æœä¸æ˜¯Proç”¨æˆ·,æ·»åŠ æ°´å°
  if (!isPro) {
    const ctx = canvas.getContext('2d');
    if (ctx) {
      // æ·»åŠ åŠé€æ˜æ°´å°
      ctx.globalAlpha = 0.3;
      ctx.font = '24px Arial';
      ctx.fillStyle = '#666666';
      ctx.textAlign = 'center';
      ctx.fillText('arabic-calligraphy-generator.com', canvas.width / 2, canvas.height - 30);
      ctx.globalAlpha = 1.0;
    }
  }
  
  // ä¸‹è½½
  const dataUrl = canvas.toDataURL('image/png', 1.0);
  // ...
};
```

---

## å®æ–½æ­¥éª¤

### Phase 1: ç¯å¢ƒå‡†å¤‡ (1å¤©)

#### 1.1 æ•°æ®åº“é…ç½®

```bash
# 1. æ³¨å†ŒNeonè´¦å·: https://neon.tech
# 2. åˆ›å»ºæ–°é¡¹ç›®: arabic-calligraphy-generator
# 3. è·å–è¿æ¥å­—ç¬¦ä¸²
# 4. æ·»åŠ åˆ°.env.local

DATABASE_URL="postgresql://user:password@host/database?sslmode=require"
```

#### 1.2 å®‰è£…ä¾èµ–

```bash
cd /Users/qiuweisen/CascadeProjects/arabic-calligraphy-creator

# å®‰è£…æ ¸å¿ƒä¾èµ–
npm install better-auth drizzle-orm @neondatabase/serverless stripe date-fns

# å®‰è£…å¼€å‘ä¾èµ–
npm install -D drizzle-kit
```

#### 1.3 é…ç½®Stripe

```bash
# 1. ç™»å½•Stripe Dashboard: https://dashboard.stripe.com
# 2. åˆ›å»ºäº§å“: Pro Subscription
# 3. åˆ›å»ºä»·æ ¼: $29.99/year
# 4. è·å–APIå¯†é’¥å’ŒPrice ID
# 5. é…ç½®Webhook endpoint: https://your-domain.com/api/payment/webhook
# 6. æ·»åŠ åˆ°.env.local

STRIPE_SECRET_KEY="sk_test_..."
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_..."
STRIPE_WEBHOOK_SECRET="whsec_..."
STRIPE_PRICE_ID_PRO_YEARLY="price_..."
```

### Phase 2: æ–‡ä»¶è¿ç§» (1-2å¤©)

#### 2.1 å¤åˆ¶æ ¸å¿ƒæ¨¡å—

âš ï¸ **é‡è¦**: ä½¿ç”¨æ­£ç¡®çš„ç›®å½•ç»“æ„,ä¿æŒä¸ç°æœ‰é¡¹ç›®ä¸€è‡´

```bash
# ä»mksaaså¤åˆ¶åˆ°å½“å‰é¡¹ç›®
cd /Users/qiuweisen/CascadeProjects/arabic-calligraphy-creator

# 1. å¤åˆ¶è®¤è¯æ¨¡å— (lib/auth*)
cp mksaas_template-cloudflare/src/lib/auth.ts lib/
cp mksaas_template-cloudflare/src/lib/auth-client.ts lib/

# 2. å¤åˆ¶URLå·¥å…· (authä¾èµ–)
mkdir -p lib/urls
cp mksaas_template-cloudflare/src/lib/urls/urls.ts lib/urls/

# 3. å¤åˆ¶æ”¯ä»˜æ¨¡å— (æ•´ä¸ªç›®å½•)
cp -r mksaas_template-cloudflare/src/payment ./

# 4. å¤åˆ¶ç§¯åˆ†æ¨¡å—(é¢„ç•™,æ•´ä¸ªç›®å½•)
cp -r mksaas_template-cloudflare/src/credits ./

# 5. å¤åˆ¶æ•°æ®åº“æ¨¡å—
cp -r mksaas_template-cloudflare/src/db ./

# 6. å¤åˆ¶é…ç½®æ–‡ä»¶
cp mksaas_template-cloudflare/src/config/website.tsx config/
cp mksaas_template-cloudflare/src/config/price-config.tsx config/
cp mksaas_template-cloudflare/src/config/credits-config.tsx config/ # å¯é€‰

# 7. å¤åˆ¶å·¥å…·å‡½æ•°
cp mksaas_template-cloudflare/src/lib/price-plan.ts lib/

# 8. å¤åˆ¶é‚®ä»¶æ¨¡å—(authçš„é‚®ç®±éªŒè¯éœ€è¦)
mkdir -p mail
cp -r mksaas_template-cloudflare/src/mail/* mail/
```

**å¤åˆ¶åçš„ç›®å½•ç»“æ„éªŒè¯**:
```bash
# éªŒè¯å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la lib/auth.ts lib/auth-client.ts
ls -la payment/index.ts payment/provider/stripe.ts
ls -la db/index.ts db/schema.ts
ls -la config/website.tsx config/price-config.tsx
```

#### 2.2 åˆ›å»ºé…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `config/subscription.ts`

```typescript
// å‰é¢å·²å®šä¹‰,å‚è€ƒ"è®¢é˜…è®¡åˆ’é…ç½®"éƒ¨åˆ†
```

**æ–‡ä»¶**: `drizzle.config.ts`

```typescript
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'postgresql',
  schema: './db/schema.ts',
  out: './db/migrations',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

#### 2.3 è°ƒæ•´å¯¼å…¥è·¯å¾„

âš ï¸ **å…³é”®æ­¥éª¤**: ç”±äºmksaasä½¿ç”¨ `src/` ç»“æ„,éœ€è¦æ‰¹é‡è°ƒæ•´å¯¼å…¥è·¯å¾„

```bash
# åœ¨æ‰€æœ‰å¤åˆ¶çš„æ–‡ä»¶ä¸­,å°†å¯¼å…¥è·¯å¾„è°ƒæ•´ä¸ºé¡¹ç›®çš„æ ¹ç›®å½•ç»“æ„
# ä¸éœ€è¦æ”¹tsconfig,å› ä¸º@/*å·²ç»æŒ‡å‘./

# ç¤ºä¾‹: lib/auth.ts ä¸­çš„å¯¼å…¥éœ€è¦ä»
# import { websiteConfig } from '@/config/website';
# ä¿æŒä¸å˜(å› ä¸º@/å·²ç»æŒ‡å‘æ ¹ç›®å½•)

# ä½†æ˜¯mksaasä¸­å¯èƒ½æœ‰ import from '@/src/...'
# éœ€è¦å»æ‰ /src éƒ¨åˆ†

# ä½¿ç”¨VS Codeå…¨å±€æœç´¢æ›¿æ¢:
# æœç´¢: from '@/src/
# æ›¿æ¢ä¸º: from '@/

# æˆ–è€…ä½¿ç”¨å‘½ä»¤è¡Œæ‰¹é‡æ›¿æ¢
find . -type f \( -name "*.ts" -o -name "*.tsx" \) \
  -not -path "./node_modules/*" \
  -not -path "./mksaas_template-cloudflare/*" \
  -exec sed -i '' 's/@\/src\//@\//g' {} +
```

**éªŒè¯å¯¼å…¥è·¯å¾„**:
```bash
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é”™è¯¯çš„å¯¼å…¥è·¯å¾„
grep -r "@/src/" --include="*.ts" --include="*.tsx" \
  --exclude-dir=node_modules \
  --exclude-dir=mksaas_template-cloudflare
# åº”è¯¥æ²¡æœ‰è¾“å‡º,å¦‚æœæœ‰åˆ™éœ€è¦æ‰‹åŠ¨ä¿®æ­£
```

### Phase 3: æ•°æ®åº“åˆå§‹åŒ– (0.5å¤©)

```bash
# 1. ç”Ÿæˆè¿ç§»æ–‡ä»¶
npx drizzle-kit generate

# 2. æŸ¥çœ‹ç”Ÿæˆçš„SQL
cat db/migrations/0000_*.sql

# 3. æ‰§è¡Œè¿ç§»
npx drizzle-kit migrate

# 4. éªŒè¯è¡¨ç»“æ„
npx drizzle-kit studio
# åœ¨æµè§ˆå™¨æ‰“å¼€ https://local.drizzle.studio
```

### Phase 4: è®¤è¯åŠŸèƒ½å®ç° (2å¤©)

#### 4.1 åˆ›å»ºAPIè·¯ç”±

**æ–‡ä»¶**: `app/api/auth/[...all]/route.ts`

```typescript
import { auth } from '@/lib/auth';
import { toNextJsHandler } from "better-auth/next-js";

export const { GET, POST } = toNextJsHandler(auth);
```

#### 4.2 åˆ›å»ºè®¤è¯é¡µé¢

**ç™»å½•é¡µ**: `app/(auth)/login/page.tsx`

```typescript
import { LoginForm } from '@/components/auth/login-form';
import { Suspense } from 'react';

export default function LoginPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-amber-50 to-white">
      <div className="w-full max-w-md px-4">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            ç™»å½•åˆ°é˜¿æ‹‰ä¼¯ä¹¦æ³•ç”Ÿæˆå™¨
          </h1>
          <p className="text-gray-600">
            ä½¿ç”¨ä½ çš„è´¦å·ç»§ç»­ä½¿ç”¨
          </p>
        </div>
        
        <Suspense fallback={<div>Loading...</div>}>
          <LoginForm />
        </Suspense>
        
        <p className="text-center mt-4 text-sm text-gray-600">
          è¿˜æ²¡æœ‰è´¦å·?{' '}
          <a href="/register" className="text-amber-600 hover:text-amber-700">
            ç«‹å³æ³¨å†Œ
          </a>
        </p>
      </div>
    </div>
  );
}
```

**æ³¨å†Œé¡µ**: `app/(auth)/register/page.tsx` (ç±»ä¼¼ç»“æ„)

#### 4.3 åˆ›å»ºè®¤è¯ç»„ä»¶

**æ–‡ä»¶**: `components/auth/login-form.tsx` (ä»mksaaså¤åˆ¶å¹¶è°ƒæ•´)

ä¸»è¦åŠŸèƒ½:
- Email + Passwordç™»å½•
- OAuthç™»å½•æŒ‰é’®
- é”™è¯¯å¤„ç†
- åŠ è½½çŠ¶æ€
- é‡å®šå‘å¤„ç†

#### å¯¼èˆªæ é›†æˆ

âš ï¸ **å…³é”®ä¿®æ­£**: ä½¿ç”¨next-intlçš„Linkå’ŒuseLocale,ä¸å†™æ­»è·¯å¾„

**æ–‡ä»¶**: `components/navbar.tsx` (ä¿®æ”¹ç°æœ‰æ–‡ä»¶)

```typescript
'use client';

import { authClient } from '@/lib/auth-client';
import { useSubscriptionStatus } from '@/hooks/use-subscription';
import Link from 'next/link';
import { useLocale } from 'next-intl';

export function Navbar() {
  const { data: session } = authClient.useSession();
  const { isPro } = useSubscriptionStatus();
  const locale = useLocale();

  return (
    <nav>
      {/* Logo */}
      <Link href={`/${locale}/`}>...</Link>
      
      {/* å¯¼èˆªé“¾æ¥ */}
      <Link href={`/${locale}/pricing`}>
        {t('nav.pricing')}
      </Link>
      
      {/* ç”¨æˆ·èœå• */}
      {session?.user ? (
        <DropdownMenu>
          <DropdownMenuTrigger>
            <Avatar>
              <AvatarImage src={session.user.image} />
              <AvatarFallback>{session.user.name?.[0]}</AvatarFallback>
            </Avatar>
          </DropdownMenuTrigger>
          <DropdownMenuContent>
            <DropdownMenuItem>
              <Link href={`/${locale}/dashboard`}>
                {t('nav.dashboard')}
              </Link>
            </DropdownMenuItem>
            {!isPro && (
              <DropdownMenuItem>
                <Link href={`/${locale}/pricing`} className="text-amber-600 font-semibold">
                  âš¡ {t('nav.upgradeToPro')}
                </Link>
              </DropdownMenuItem>
            )}
            <DropdownMenuItem onClick={() => authClient.signOut()}>
              {t('nav.signOut')}
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      ) : (
        <div className="flex gap-2">
          <Button variant="ghost" asChild>
            <Link href={`/${locale}/login`}>{t('nav.login')}</Link>
          </Button>
          <Button asChild>
            <Link href={`/${locale}/register`}>{t('nav.register')}</Link>
          </Button>
        </div>
      )}
    </nav>
  );
}
```

### 2. å®šä»·é¡µé¢ç»„ä»¶

âš ï¸ **PricingCardç»„ä»¶ç”¨æ³•ä¿®æ­£**: å‚è€ƒmksaaså®é™…props

**æ–‡ä»¶**: `app/[locale]/pricing/page.tsx` (æ–°å»º)

```typescript
import { getPricePlans } from '@/config/price-config';
import { PricingCard } from '@/components/payment/pricing-card';
import { PlanIntervals, PaymentTypes } from '@/payment/types';

export default function PricingPage() {
  // ä»é…ç½®è·å–è®¡åˆ’(å®¢æˆ·ç«¯ç»„ä»¶)
  const plans = getPricePlans();

  return (
    <div className="container mx-auto py-16">
      <h1 className="text-4xl font-bold text-center mb-12">
        Choose Your Plan
      </h1>
      
      <div className="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
        {/* Freeè®¡åˆ’ */}
        <PricingCard
          plan={plans.free}
          // Freeè®¡åˆ’ä¸éœ€è¦intervalå‚æ•°
        />
        
        {/* Proè®¡åˆ’ - âš ï¸ åªä¼ planå’Œinterval */}
        <PricingCard
          plan={plans.pro}
          interval={PlanIntervals.YEAR}
          // paymentTypeä¼šè‡ªåŠ¨è¯†åˆ«ä¸ºSUBSCRIPTION
        />
      </div>
    </div>
  );
}
```

**è¯´æ˜**:
- `PricingCard` ç»„ä»¶props: `plan: PricePlan`, `interval?: PlanInterval`, `paymentType?: PaymentType`, `metadata?: Record<string, string>`, `className?: string`, `isCurrentPlan?: boolean`
- ä¸è¦ä¼  `planId`/`priceId` ç­‰å•ç‹¬å‚æ•°,æ‰€æœ‰ä¿¡æ¯ä» `plan` å¯¹è±¡è·å–
- UIæ–‡æ¡ˆ(name/description/features)é€šè¿‡ `getPricePlans()` è‡ªåŠ¨æ³¨å…¥å¤šè¯­è¨€
- `interval` ç”¨äºåœ¨å¤šä¸ªä»·æ ¼é€‰é¡¹ä¸­é€‰æ‹©(å¦‚æœˆä»˜/å¹´ä»˜),Proå¹´ä»˜ä¼  `PlanIntervals.YEAR`

#### PNGä¸‹è½½ - æ·»åŠ æ°´å°

âš ï¸ **å…³é”®**: ä½¿ç”¨hookè·å–çš„è®¢é˜…çŠ¶æ€,ä¸åœ¨å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨æ•°æ®åº“å‡½æ•°

**æ–‡ä»¶**: `components/calligraphy-generator.tsx` (ä¿®æ”¹)

```typescript
const handleDownloadPNG = async () => {
  // âœ… ä»hookè·å–è®¢é˜…çŠ¶æ€(å·²ç»åœ¨ç»„ä»¶ä¸­å®šä¹‰)
  // const { isPro } = useSubscriptionStatus();
  
  // ç”Ÿæˆcanvas
  const canvas = await generatePreviewCanvas(previewRef.current, currentOptions, 4);
  
  // å¦‚æœä¸æ˜¯Proç”¨æˆ·,æ·»åŠ æ°´å°
  if (!isPro) {
    const ctx = canvas.getContext('2d');
    if (ctx) {
      // æ·»åŠ åŠé€æ˜æ°´å°
      ctx.globalAlpha = 0.3;
      ctx.font = '24px Arial';
      ctx.fillStyle = '#666666';
      ctx.textAlign = 'center';
      ctx.fillText('arabic-calligraphy-generator.com', canvas.width / 2, canvas.height - 30);
      ctx.globalAlpha = 1.0;
    }
  }
  
  // ä¸‹è½½
  const dataUrl = canvas.toDataURL('image/png', 1.0);
  // ...
};
```

---

## å®æ–½æ­¥éª¤

### Phase 1: ç¯å¢ƒå‡†å¤‡ (1å¤©)

#### 1.1 æ•°æ®åº“é…ç½®

```bash
# 1. æ³¨å†ŒNeonè´¦å·: https://neon.tech
# 2. åˆ›å»ºæ–°é¡¹ç›®: arabic-calligraphy-generator
# 3. è·å–è¿æ¥å­—ç¬¦ä¸²
# 4. æ·»åŠ åˆ°.env.local

DATABASE_URL="postgresql://user:password@host/database?sslmode=require"
```

#### 1.2 å®‰è£…ä¾èµ–

```bash
cd /Users/qiuweisen/CascadeProjects/arabic-calligraphy-creator

# å®‰è£…æ ¸å¿ƒä¾èµ–
npm install better-auth drizzle-orm @neondatabase/serverless stripe date-fns

# å®‰è£…å¼€å‘ä¾èµ–
npm install -D drizzle-kit
```

#### 1.3 é…ç½®Stripe

```bash
# 1. ç™»å½•Stripe Dashboard: https://dashboard.stripe.com
# 2. åˆ›å»ºäº§å“: Pro Subscription
# 3. åˆ›å»ºä»·æ ¼: $29.99/year
# 4. è·å–APIå¯†é’¥å’ŒPrice ID
# 5. é…ç½®Webhook endpoint: https://your-domain.com/api/payment/webhook
# 6. æ·»åŠ åˆ°.env.local

STRIPE_SECRET_KEY="sk_test_..."
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_..."
STRIPE_WEBHOOK_SECRET="whsec_..."
STRIPE_PRICE_ID_PRO_YEARLY="price_..."
```

### Phase 2: æ–‡ä»¶è¿ç§» (1-2å¤©)

#### 2.1 å¤åˆ¶æ ¸å¿ƒæ¨¡å—

âš ï¸ **é‡è¦**: ä½¿ç”¨æ­£ç¡®çš„ç›®å½•ç»“æ„,ä¿æŒä¸ç°æœ‰é¡¹ç›®ä¸€è‡´

```bash
# ä»mksaaså¤åˆ¶åˆ°å½“å‰é¡¹ç›®
cd /Users/qiuweisen/CascadeProjects/arabic-calligraphy-creator

# 1. å¤åˆ¶è®¤è¯æ¨¡å— (lib/auth*)
cp mksaas_template-cloudflare/src/lib/auth.ts lib/
cp mksaas_template-cloudflare/src/lib/auth-client.ts lib/

# 2. å¤åˆ¶URLå·¥å…· (authä¾èµ–)
mkdir -p lib/urls
cp mksaas_template-cloudflare/src/lib/urls/urls.ts lib/urls/

# 3. å¤åˆ¶æ”¯ä»˜æ¨¡å— (æ•´ä¸ªç›®å½•)
cp -r mksaas_template-cloudflare/src/payment ./

# 4. å¤åˆ¶ç§¯åˆ†æ¨¡å—(é¢„ç•™,æ•´ä¸ªç›®å½•)
cp -r mksaas_template-cloudflare/src/credits ./

# 5. å¤åˆ¶æ•°æ®åº“æ¨¡å—
cp -r mksaas_template-cloudflare/src/db ./

# 6. å¤åˆ¶é…ç½®æ–‡ä»¶
cp mksaas_template-cloudflare/src/config/website.tsx config/
cp mksaas_template-cloudflare/src/config/price-config.tsx config/
cp mksaas_template-cloudflare/src/config/credits-config.tsx config/ # å¯é€‰

# 7. å¤åˆ¶å·¥å…·å‡½æ•°
cp mksaas_template-cloudflare/src/lib/price-plan.ts lib/

# 8. å¤åˆ¶é‚®ä»¶æ¨¡å—(authçš„é‚®ç®±éªŒè¯éœ€è¦)
mkdir -p mail
cp -r mksaas_template-cloudflare/src/mail/* mail/
```

**å¤åˆ¶åçš„ç›®å½•ç»“æ„éªŒè¯**:
```bash
# éªŒè¯å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la lib/auth.ts lib/auth-client.ts
ls -la payment/index.ts payment/provider/stripe.ts
ls -la db/index.ts db/schema.ts
ls -la config/website.tsx config/price-config.tsx
```

#### 2.2 åˆ›å»ºé…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `config/subscription.ts`

```typescript
// å‰é¢å·²å®šä¹‰,å‚è€ƒ"è®¢é˜…è®¡åˆ’é…ç½®"éƒ¨åˆ†
```

**æ–‡ä»¶**: `drizzle.config.ts`

```typescript
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'postgresql',
  schema: './db/schema.ts',
  out: './db/migrations',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

#### 2.3 è°ƒæ•´å¯¼å…¥è·¯å¾„

âš ï¸ **å…³é”®æ­¥éª¤**: ç”±äºmksaasä½¿ç”¨ `src/` ç»“æ„,éœ€è¦æ‰¹é‡è°ƒæ•´å¯¼å…¥è·¯å¾„

```bash
# åœ¨æ‰€æœ‰å¤åˆ¶çš„æ–‡ä»¶ä¸­,å°†å¯¼å…¥è·¯å¾„è°ƒæ•´ä¸ºé¡¹ç›®çš„æ ¹ç›®å½•ç»“æ„
# ä¸éœ€è¦æ”¹tsconfig,å› ä¸º@/*å·²ç»æŒ‡å‘./

# ç¤ºä¾‹: lib/auth.ts ä¸­çš„å¯¼å…¥éœ€è¦ä»
# import { websiteConfig } from '@/config/website';
# ä¿æŒä¸å˜(å› ä¸º@/å·²ç»æŒ‡å‘æ ¹ç›®å½•)

# ä½†æ˜¯mksaasä¸­å¯èƒ½æœ‰ import from '@/src/...'
# éœ€è¦å»æ‰ /src éƒ¨åˆ†

# ä½¿ç”¨VS Codeå…¨å±€æœç´¢æ›¿æ¢:
# æœç´¢: from '@/src/
# æ›¿æ¢ä¸º: from '@/

# æˆ–è€…ä½¿ç”¨å‘½ä»¤è¡Œæ‰¹é‡æ›¿æ¢
find . -type f \( -name "*.ts" -o -name "*.tsx" \) \
  -not -path "./node_modules/*" \
  -not -path "./mksaas_template-cloudflare/*" \
  -exec sed -i '' 's/@\/src\//@\//g' {} +
```

**éªŒè¯å¯¼å…¥è·¯å¾„**:
```bash
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é”™è¯¯çš„å¯¼å…¥è·¯å¾„
grep -r "@/src/" --include="*.ts" --include="*.tsx" \
  --exclude-dir=node_modules \
  --exclude-dir=mksaas_template-cloudflare
# åº”è¯¥æ²¡æœ‰è¾“å‡º,å¦‚æœæœ‰åˆ™éœ€è¦æ‰‹åŠ¨ä¿®æ­£
```

### Phase 3: æ•°æ®åº“åˆå§‹åŒ– (0.5å¤©)

```bash
# 1. ç”Ÿæˆè¿ç§»æ–‡ä»¶
npx drizzle-kit generate

# 2. æŸ¥çœ‹ç”Ÿæˆçš„SQL
cat db/migrations/0000_*.sql

# 3. æ‰§è¡Œè¿ç§»
npx drizzle-kit migrate

# 4. éªŒè¯è¡¨ç»“æ„
npx drizzle-kit studio
# åœ¨æµè§ˆå™¨æ‰“å¼€ https://local.drizzle.studio
```

### Phase 4: è®¤è¯åŠŸèƒ½å®ç° (2å¤©)

#### 4.1 åˆ›å»ºAPIè·¯ç”±

**æ–‡ä»¶**: `app/api/auth/[...all]/route.ts`

```typescript
import { auth } from '@/lib/auth';
import { toNextJsHandler } from "better-auth/next-js";

export const { GET, POST } = toNextJsHandler(auth);
```

#### 4.2 åˆ›å»ºè®¤è¯é¡µé¢

**ç™»å½•é¡µ**: `app/(auth)/login/page.tsx`

```typescript
import { LoginForm } from '@/components/auth/login-form';
import { Suspense } from 'react';

export default function LoginPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-amber-50 to-white">
      <div className="w-full max-w-md px-4">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            ç™»å½•åˆ°é˜¿æ‹‰ä¼¯ä¹¦æ³•ç”Ÿæˆå™¨
          </h1>
          <p className="text-gray-600">
            ä½¿ç”¨ä½ çš„è´¦å·ç»§ç»­ä½¿ç”¨
          </p>
        </div>
        
        <Suspense fallback={<div>Loading...</div>}>
          <LoginForm />
        </Suspense>
        
        <p className="text-center mt-4 text-sm text-gray-600">
          è¿˜æ²¡æœ‰è´¦å·?{' '}
          <a href="/register" className="text-amber-600 hover:text-amber-700">
            ç«‹å³æ³¨å†Œ
          </a>
        </p>
      </div>
    </div>
  );
}
```

**æ³¨å†Œé¡µ**: `app/(auth)/register/page.tsx` (ç±»ä¼¼ç»“æ„)

#### 4.3 åˆ›å»ºè®¤è¯ç»„ä»¶

**æ–‡ä»¶**: `components/auth/login-form.tsx` (ä»mksaaså¤åˆ¶å¹¶è°ƒæ•´)

ä¸»è¦åŠŸèƒ½:
- Email + Passwordç™»å½•
- OAuthç™»å½•æŒ‰é’®
- é”™è¯¯å¤„ç†
- åŠ è½½çŠ¶æ€
- é‡å®šå‘å¤„ç†

#### å¯¼èˆªæ é›†æˆ

âš ï¸ **å…³é”®ä¿®æ­£**: ä½¿ç”¨next-intlçš„Linkå’ŒuseLocale,ä¸å†™æ­»è·¯å¾„

**æ–‡ä»¶**: `components/navbar.tsx` (ä¿®æ”¹ç°æœ‰æ–‡ä»¶)

```typescript
'use client';

import { authClient } from '@/lib/auth-client';
import { useSubscriptionStatus } from '@/hooks/use-subscription';
import Link from 'next/link';
import { useLocale } from 'next-intl';

export function Navbar() {
  const { data: session } = authClient.useSession();
  const { isPro } = useSubscriptionStatus();
  const locale = useLocale();

  return (
    <nav>
      {/* Logo */}
      <Link href={`/${locale}/`}>...</Link>
      
      {/* å¯¼èˆªé“¾æ¥ */}
      <Link href={`/${locale}/pricing`}>
        {t('nav.pricing')}
      </Link>
      
      {/* ç”¨æˆ·èœå• */}
      {session?.user ? (
        <DropdownMenu>
          <DropdownMenuTrigger>
            <Avatar>
              <AvatarImage src={session.user.image} />
              <AvatarFallback>{session.user.name?.[0]}</AvatarFallback>
            </Avatar>
          </DropdownMenuTrigger>
          <DropdownMenuContent>
            <DropdownMenuItem>
              <Link href={`/${locale}/dashboard`}>
                {t('nav.dashboard')}
              </Link>
            </DropdownMenuItem>
            {!isPro && (
              <DropdownMenuItem>
                <Link href={`/${locale}/pricing`} className="text-amber-600 font-semibold">
                  âš¡ {t('nav.upgradeToPro')}
                </Link>
              </DropdownMenuItem>
            )}
            <DropdownMenuItem onClick={() => authClient.signOut()}>
              {t('nav.signOut')}
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      ) : (
        <div className="flex gap-2">
          <Button variant="ghost" asChild>
            <Link href={`/${locale}/login`}>{t('nav.login')}</Link>
          </Button>
          <Button asChild>
            <Link href={`/${locale}/register`}>{t('nav.register')}</Link>
          </Button>
        </div>
      )}
    </nav>
  );
}
```

### 2. å®šä»·é¡µé¢ç»„ä»¶

âš ï¸ **PricingCardç»„ä»¶ç”¨æ³•ä¿®æ­£**: å‚è€ƒmksaaså®é™…props

**æ–‡ä»¶**: `app/[locale]/pricing/page.tsx` (æ–°å»º)

```typescript
import { getPricePlans } from '@/config/price-config';
import { PricingCard } from '@/components/payment/pricing-card';
import { PlanIntervals, PaymentTypes } from '@/payment/types';

export default function PricingPage() {
  // ä»é…ç½®è·å–è®¡åˆ’(å®¢æˆ·ç«¯ç»„ä»¶)
  const plans = getPricePlans();

  return (
    <div className="container mx-auto py-16">
      <h1 className="text-4xl font-bold text-center mb-12">
        Choose Your Plan
      </h1>
      
      <div className="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
        {/* Freeè®¡åˆ’ */}
        <PricingCard
          plan={plans.free}
          // Freeè®¡åˆ’ä¸éœ€è¦intervalå‚æ•°
        />
        
        {/* Proè®¡åˆ’ - âš ï¸ åªä¼ planå’Œinterval */}
        <PricingCard
          plan={plans.pro}
          interval={PlanIntervals.YEAR}
          // paymentTypeä¼šè‡ªåŠ¨è¯†åˆ«ä¸ºSUBSCRIPTION
        />
      </div>
    </div>
  );
}
```

**è¯´æ˜**:
- `PricingCard` ç»„ä»¶props: `plan: PricePlan`, `interval?: PlanInterval`, `paymentType?: PaymentType`, `metadata?: Record<string, string>`, `className?: string`, `isCurrentPlan?: boolean`
- ä¸è¦ä¼  `planId`/`priceId` ç­‰å•ç‹¬å‚æ•°,æ‰€æœ‰ä¿¡æ¯ä» `plan` å¯¹è±¡è·å–
- UIæ–‡æ¡ˆ(name/description/features)é€šè¿‡ `getPricePlans()` è‡ªåŠ¨æ³¨å…¥å¤šè¯­è¨€
- `interval` ç”¨äºåœ¨å¤šä¸ªä»·æ ¼é€‰é¡¹ä¸­é€‰æ‹©(å¦‚æœˆä»˜/å¹´ä»˜),Proå¹´ä»˜ä¼  `PlanIntervals.YEAR`

#### PNGä¸‹è½½ - æ·»åŠ æ°´å°

âš ï¸ **å…³é”®**: ä½¿ç”¨hookè·å–çš„è®¢é˜…çŠ¶æ€,ä¸åœ¨å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨æ•°æ®åº“å‡½æ•°

**æ–‡ä»¶**: `components/calligraphy-generator.tsx` (ä¿®æ”¹)

```typescript
const handleDownloadPNG = async () => {
  // âœ… ä»hookè·å–è®¢é˜…çŠ¶æ€(å·²ç»åœ¨ç»„ä»¶ä¸­å®šä¹‰)
  // const { isPro } = useSubscriptionStatus();
  
  // ç”Ÿæˆcanvas
  const canvas = await generatePreviewCanvas(previewRef.current, currentOptions, 4);
  
  // å¦‚æœä¸æ˜¯Proç”¨æˆ·,æ·»åŠ æ°´å°
  if (!isPro) {
    const ctx = canvas.getContext('2d');
    if (ctx) {
      // æ·»åŠ åŠé€æ˜æ°´å°
      ctx.globalAlpha = 0.3;
      ctx.font = '24px Arial';
      ctx.fillStyle = '#666666';
      ctx.textAlign = 'center';
      ctx.fillText('arabic-call